<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Heads Up Motion Test</title>
    <style>
        /* --- CORE STYLES --- */
        :root {
            --bg: #2d3436;
            --green: #27ae60;
            --red: #c0392b;
            --text: white;
        }
        body {
            background: var(--bg);
            color: var(--text);
            font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            overflow: hidden;
            touch-action: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }

        /* --- VIEWS --- */
        .screen {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            transition: background 0.3s;
        }
        .screen.active { display: flex; }

        /* --- UI ELEMENTS --- */
        h1 { font-size: 15vh; margin: 0; line-height: 1; text-transform: uppercase; }
        p { font-size: 1.5rem; color: #b2bec3; margin: 20px; max-width: 80%; }
        
        button {
            background: #0984e3;
            border: none;
            color: white;
            padding: 20px 40px;
            font-size: 1.5rem;
            border-radius: 12px;
            font-weight: bold;
            box-shadow: 0 4px 0 #075b9e;
        }
        button:active { transform: translateY(4px); box-shadow: none; }

        /* --- DEBUG STRIP --- */
        #debug {
            position: absolute;
            bottom: 0; left: 0;
            width: 100%;
            background: rgba(0,0,0,0.5);
            font-family: monospace;
            font-size: 12px;
            padding: 5px;
            pointer-events: none;
            text-align: left;
            z-index: 999;
        }

        /* --- ORIENTATION MESSAGE --- */
        .landscape-hint {
            display: none;
            position: absolute;
            top: 10px;
            font-size: 0.8rem;
            opacity: 0.5;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        /* Show hint if in portrait */
        @media (orientation: portrait) { .landscape-hint { display: block; } }

    </style>
</head>
<body>

    <div id="home" class="screen active">
        <div class="landscape-hint">Please Rotate Phone Sideways</div>
        <p style="font-size: 4rem;">üé≠</p>
        <h1>Charades</h1>
        <p>1. Lock Orientation<br>2. Rotate Sideways<br>3. Place on Forehead</p>
        <button onclick="requestPerms()">Start Game</button>
    </div>

    <div id="countdown" class="screen">
        <h1 id="count-display">3</h1>
        <p>Calibrating... Keep Steady!</p>
    </div>

    <div id="game" class="screen">
        <div style="position: absolute; top: 20px; right: 20px; font-weight:bold; font-size: 2rem;">
            ‚è± <span id="timer">60</span>
        </div>
        <div style="position: absolute; top: 20px; left: 20px; font-weight:bold; font-size: 2rem;">
            Score: <span id="score">0</span>
        </div>
        
        <h1 id="word">Word</h1>
        
        <div style="position: absolute; bottom: 30px; font-size: 1.2rem; opacity: 0.8;">
            Tilt Screen to <b>Floor</b> = Correct<br>
            Tilt Screen to <b>Ceiling</b> = Pass
        </div>
    </div>

    <div id="result" class="screen">
        <h1>Time's Up!</h1>
        <p>Score: <span id="final-score">0</span></p>
        <button onclick="location.reload()">Play Again</button>
    </div>

    <div id="debug">Initializing...</div>

    <script>
        // --- CONFIG ---
        const WORDS = ["Lion", "Pizza", "Titanic", "Beyonce", "T-Rex", "Shower", "Zombie", "Guitar", "Superman"];
        const ROUND_TIME = 60;
        const TILT_ANGLE = 35; // How many degrees to tilt to trigger
        const RESET_ANGLE = 15; // How close to vertical to reset

        // --- STATE ---
        let state = {
            screen: 'home',
            neutralGamma: 0, // The "Zero" point on your forehead
            orientationDir: 1, // 1 or -1 based on how you hold the phone
            wordIndex: 0,
            score: 0,
            timeLeft: ROUND_TIME,
            triggerState: 'ready' // 'ready' or 'triggered'
        };
        
        let timerInt;
        let lastGamma = 0;

        // --- SETUP ---
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            state.screen = id;
        }

        // --- PERMISSIONS (iOS 13+) ---
        function requestPerms() {
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(resp => {
                        if (resp === 'granted') startCountdown();
                        else alert("Motion permission required!");
                    })
                    .catch(console.error);
            } else {
                startCountdown();
            }
        }

        // --- COUNTDOWN & CALIBRATION ---
        function startCountdown() {
            showScreen('countdown');
            window.addEventListener('deviceorientation', handleMotion);
            
            let count = 3;
            document.getElementById('count-display').innerText = count;
            
            let int = setInterval(() => {
                count--;
                if(count > 0) {
                    document.getElementById('count-display').innerText = count;
                } else {
                    clearInterval(int);
                    calibrate();
                    startGame();
                }
            }, 1000);
        }

        // This is the magic fix. We capture the angle of your forehead.
        function calibrate() {
            state.neutralGamma = lastGamma;
            
            // Detect if holding Left-landscape or Right-landscape
            // If neutralGamma is positive (e.g., 90), phone is one way.
            // If negative (e.g., -90), phone is the other way.
            // We want "Tilting Down" (screen to floor) to always be POSITIVE math.
            
            if (state.neutralGamma < 0) {
                state.orientationDir = -1; 
            } else {
                state.orientationDir = 1;
            }
        }

        // --- GAME LOOP ---
        function startGame() {
            showScreen('game');
            state.score = 0;
            state.timeLeft = ROUND_TIME;
            updateWord();
            
            timerInt = setInterval(() => {
                state.timeLeft--;
                document.getElementById('timer').innerText = state.timeLeft;
                if(state.timeLeft <= 0) endGame();
            }, 1000);
        }

        function endGame() {
            clearInterval(timerInt);
            window.removeEventListener('deviceorientation', handleMotion);
            document.getElementById('final-score').innerText = state.score;
            showScreen('result');
        }

        function updateWord() {
            document.getElementById('word').innerText = WORDS[state.wordIndex % WORDS.length];
            document.getElementById('score').innerText = state.score;
            // Visual Reset
            document.body.style.backgroundColor = '#2d3436';
        }

        // --- THE MOTION ENGINE ---
        function handleMotion(e) {
            let gamma = e.gamma; // Rotation around the long edge
            if (gamma === null) return;
            
            lastGamma = gamma;
            
            // Debug text to help you see what's happening
            document.getElementById('debug').innerHTML = 
                `Raw Gamma: ${gamma.toFixed(0)}¬∞ | Neutral: ${state.neutralGamma.toFixed(0)}¬∞`;

            if (state.screen !== 'game') return;

            // Math: Calculate how far we are from the forehead position
            let diff = (gamma - state.neutralGamma);
            
            // Normalize direction so Down is always the same mathematical sign
            // On iOS: Face Down usually moves towards +/-180.
            // On iOS: Face Up usually moves towards 0.
            
            // If we started at -90 (vertical):
            // Tipping Down goes to -180. Diff is -90.
            // Tipping Up goes to 0. Diff is +90.
            
            // If we started at +90 (vertical):
            // Tipping Down goes to +180. Diff is +90.
            // Tipping Up goes to 0. Diff is -90.
            
            // We apply the orientationDir to make "Tipping Down" always act the same.
            let adjustedDiff = diff;
            if (state.neutralGamma < 0) {
                // We are at -90. Down goes to -180 (Negative change).
                // We want Down to be detected.
            }

            // Let's simplify.
            // Abs(Gamma) increases towards 180 = Face Down (Floor)
            // Abs(Gamma) decreases towards 0 = Face Up (Ceiling)
            
            let absGamma = Math.abs(gamma);
            let absNeutral = Math.abs(state.neutralGamma);
            
            if (state.triggerState === 'ready') {
                
                // DETECT TILT DOWN (CORRECT)
                // If the absolute angle moves closer to 180 (flat on face)
                if (absGamma > (absNeutral + TILT_ANGLE)) {
                    trigger('correct');
                }
                
                // DETECT TILT UP (PASS)
                // If the absolute angle moves closer to 0 (flat on back)
                else if (absGamma < (absNeutral - TILT_ANGLE)) {
                    trigger('pass');
                }
            } 
            else if (state.triggerState === 'triggered') {
                // RESET MECHANISM
                // User must return to vertical (roughly)
                if (absGamma > (absNeutral - RESET_ANGLE) && absGamma < (absNeutral + RESET_ANGLE)) {
                    state.triggerState = 'ready';
                    document.body.style.backgroundColor = '#2d3436'; // Reset color
                }
            }
        }

        function trigger(type) {
            state.triggerState = 'triggered';
            
            if (type === 'correct') {
                state.score++;
                document.body.style.backgroundColor = 'var(--green)';
                playSound(600, 'sine'); // High beep
            } else {
                document.body.style.backgroundColor = 'var(--red)';
                playSound(200, 'sawtooth'); // Low buzzing
            }
            
            state.wordIndex++;
            setTimeout(updateWord, 500);
        }

        // Simple Beep
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(freq, type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.frequency.value = freq;
            osc.type = type;
            osc.start();
            osc.stop(audioCtx.currentTime + 0.15);
        }

    </script>
</body>
</html>
