<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pocket Monster Taxonomy 2.0 - Text Only</title>
  <style>
    /* Minimalist, text-only CSS */
    * {
      box-sizing: border-box;
      font-family: monospace;
      margin: 0;
      padding: 0;
      border: 0;
    }
    body {
      padding: 2px;
      line-height: 1.2;
      padding-bottom: 5px;
      height: 100%;
    margin: 0; 
      overflow-x: hidden;
      max-width: 100vw;
    }
    .hidden {
      display: none;
    }
    #page-container {
    /* 2. Make the page container take the full height */
    min-height: 100vh; /* Use 100vh for full viewport height */
    display: flex;
    flex-direction: column; /* Stack children vertically */
}
    #content-wrap {
    /* 3. This is the magic: tell the content to grow and push the footer down */
    flex-grow: 1; 
}
    /* Layout: Everything is stacked and compact */
    h1, h3, .filter-group, .active-filters, .controls {
      display: block;
      margin: 2px 0;
    }
    .filter-options, .pokemon-container {
      display: block;
    }

    /* Filters and Buttons */
    button, .filter-chip {
      display: inline-block;
      padding: 0 1px;
      margin: 0 1px 2px 0;
      border: 1px solid #000;
      background: none;
      color: black;
      cursor: pointer;
      font-size: 10px;
      white-space: nowrap;
    }
    .selected {
      font-weight: bold;
      color: red;
      border-color: red;
    }
    .active-filter-chip {
        display: inline;
        margin-right: 2px;
        font-size: 10px;
        color: red;
        cursor: pointer;
    }
    
    .active-filter-chip .remove {
        color: red;
    }
    
    .filter-separator {
        color: black;
    }
    
    .disabled-sort {
        color: #999;
    }
    
    /* Settings Modal */
    #settingsIcon {
        position: fixed;
        top: 5px;
        right: 5px;
        font-size: 24px;
        cursor: pointer;
        z-index: 200;
        background: white;
        border: 1px solid #000;
        padding: 5px 10px;
        border-radius: 4px;
        user-select: none;
    }
    
    #settingsModal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.8);
        z-index: 300;
        overflow-y: auto;
    }
    
    #settingsContent {
        background: white;
        margin: 20px auto;
        padding: 20px;
        max-width: 500px;
        border: 2px solid #000;
        max-height: 80vh;
        overflow-y: auto;
    }
    
    .settings-section {
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #ccc;
    }
    
    .settings-section h4 {
        margin-bottom: 5px;
        font-size: 14px;
    }
    
    .settings-section label {
        display: block;
        margin: 5px 0;
        font-size: 12px;
    }
    
    .settings-section select, .settings-section input {
        margin-left: 10px;
        font-size: 12px;
    }
    
    #closeSettings {
        float: right;
        font-size: 20px;
        cursor: pointer;
        font-weight: bold;
    }

    /* Pokemon Card */
    .pokemon-card {
      display: block;
      border-top: 1px solid #000;
      padding-top: 2px;
      margin-bottom: 2px;
    }
    .pokemon-card h3 {
      display: inline;
    }
    .pokemon-card .card-details, .pokemon-abilities, .pokemon-moves {
      display: block;
    }
    .pokemon-stats {
        display: block;
    }
    .pokemon-stats.hidden {
      display: none;
    }
    .pokemon-card .clickable {
        text-decoration: underline;
    }
    .quick-clear {
      color: red;
      font-weight: bold;
      cursor: pointer;
      margin-left: 2px;
    }
    img, .attribute-icon {
        display: none !important;
    }
    .clear-button, .toggle-stats {
        margin-left: 0;
    }

    /* Collapsible Filter Bar */
    #mainFilterContainer {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
    }
    #mainFilterContainer.expanded {
        max-height: 2000px;
    }

    /* Collapsible filter sections */
    .filter-section-header {
        cursor: pointer;
        background: #eee;
        padding: 2px;
        margin: 2px 0;
        font-size: 11px;
        font-weight: bold;
    }
    
    .filter-group {
        cursor: pointer;
        padding: 4px 2px;
        margin: 0;
    }
    
    .filter-group:nth-child(even) {
        background: #eee;
    }
    
    .filter-group h3 {
        margin: 0 0 2px 0;
        pointer-events: none;
    }
    
    .filter-options {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
        margin-bottom: 2px;
        pointer-events: auto;
    }
    
    .filter-options.expanded {
        max-height: 300px;
    }

    /* Search Bar Suggestions */
    #searchBar {
        font-size: 16px !important;
        padding: 5px !important;
    }
    
    #suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid black;
        z-index: 10;
        max-height: 150px;
        overflow-y: auto;
        padding: 0;
        list-style: none;
        margin-top: 0;
    }
    #suggestions li {
        padding: 4px 6px;
        cursor: pointer;
        font-size: 14px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        border-bottom: 1px solid #eee;
    }
    #suggestions li:last-child {
        border-bottom: none;
    }
    #suggestions li:hover {
        background: #ccc;
    }

    /* Moveset specific styles */
    .move-item {
        display: inline;
        margin-right: 2px;
    }
    .learn-method {
        font-size: 8px;
        color: #666;
    }
    .loading-indicator {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 10px;
        border-radius: 4px;
        z-index: 9999;
    }
    
    #copyright {
    /* Styling for the element's appearance */
color: #999;
    padding: 2px;
    font-size: 8px;
    text-align: left;
    /* All fixed/absolute positioning and z-index are removed */
}
    
    .pokemon-container {
        padding-bottom: 20px;
        overflow-x: hidden;
        word-wrap: break-word;
    }
    
    .pokemon-moves {
        overflow-x: hidden;
        word-wrap: break-word;
        max-width: 100%;
    }
    
    .selected-result {
        color: red;
    }
  </style>
</head>
<body><div id="page-container">
    <div id="content-wrap">
    <div id="settingsIcon">⚙</div>
    
    <div id="settingsModal">
        <div id="settingsContent">
            <span id="closeSettings">×</span>
            <h3>Settings</h3>
            
            <div class="settings-section">
                <h4>Text Size</h4>
                <label>Base Font Size: <input type="number" id="baseFontSize" min="8" max="24" value="10" style="width: 50px;"> px</label>
            </div>
            
            <div class="settings-section">
                <h4>Pokemon Name Display</h4>
                <label>Show Number (#): 
                    <select id="showNumber">
                        <option value="true" selected>Show</option>
                        <option value="false">Hide</option>
                    </select>
                </label>
                <label>Show Name: 
                    <select id="showName">
                        <option value="true" selected>Show</option>
                        <option value="false">Hide</option>
                    </select>
                </label>
                <label>Show Species: 
                    <select id="showSpecies">
                        <option value="true" selected>Show</option>
                        <option value="false">Hide</option>
                    </select>
                </label>
            </div>
            
            <div class="settings-section">
                <h4>Types Display</h4>
                <label>Description: 
                    <select id="typesDesc">
                        <option value="none">None</option>
                        <option value="short">Short (T:)</option>
                        <option value="full" selected>Full (Types:)</option>
                    </select>
                </label>
                <label>Display: 
                    <select id="typesDisplay">
                        <option value="default" selected>Text</option>
                        <option value="hide">Hide</option>
                        <option value="color">Color</option>
                    </select>
                </label>
            </div>
            
            <div class="settings-section">
                <h4>Region Display</h4>
                <label>Description: 
                    <select id="regionDesc">
                        <option value="none">None</option>
                        <option value="short" selected>Short (⛴)</option>
                        <option value="full">Full (Region:)</option>
                    </select>
                </label>
                <label>Display: 
                    <select id="regionDisplay">
                        <option value="default" selected>Text</option>
                        <option value="hide">Hide</option>
                        <option value="color">Color</option>
                    </select>
                </label>
            </div>
            
            <div class="settings-section">
                <h4>Color Display</h4>
                <label>Description: 
                    <select id="colorDesc">
                        <option value="none">None</option>
                        <option value="short" selected>Short (⬔)</option>
                        <option value="full">Full (Color:)</option>
                    </select>
                </label>
                <label>Display: 
                    <select id="colorDisplay">
                        <option value="default" selected>Text</option>
                        <option value="hide">Hide</option>
                        <option value="color">Color</option>
                    </select>
                </label>
            </div>
            
            <div class="settings-section">
                <h4>Shape Display</h4>
                <label>Description: 
                    <select id="shapeDesc">
                        <option value="none">None</option>
                        <option value="short" selected>Short (⭔)</option>
                        <option value="full">Full (Shape:)</option>
                    </select>
                </label>
                <label>Display: 
                    <select id="shapeDisplay">
                        <option value="default" selected>Text</option>
                        <option value="hide">Hide</option>
                        <option value="color">Color</option>
                    </select>
                </label>
            </div>
            
            <div class="settings-section">
                <h4>Egg Groups Display</h4>
                <label>Description: 
                    <select id="eggDesc">
                        <option value="none">None</option>
                        <option value="short">Short (E:)</option>
                        <option value="full" selected>Full (Egg:)</option>
                    </select>
                </label>
                <label>Display: 
                    <select id="eggDisplay">
                        <option value="default" selected>Text</option>
                        <option value="hide">Hide</option>
                        <option value="color">Color</option>
                    </select>
                </label>
            </div>
            
            <div class="settings-section">
                <h4>Abilities Display</h4>
                <label>Description: 
                    <select id="abilitiesDesc">
                        <option value="none">None</option>
                        <option value="short">Short (A:)</option>
                        <option value="full" selected>Full (Abilities:)</option>
                    </select>
                </label>
                <label>Display: 
                    <select id="abilitiesDisplay">
                        <option value="default" selected>Text</option>
                        <option value="hide">Hide</option>
                        <option value="color">Color</option>
                    </select>
                </label>
            </div>
            
            <button onclick="applySettings()" style="margin-top: 10px; padding: 5px 10px;">Apply Settings</button>
            <button onclick="closeSettings()" style="margin-top: 10px; padding: 5px 10px;">Close</button>
        </div>
    </div>
    
    <h1>Pokémon Taxonomy</h1>
    
    <div style="position: relative; margin-top: 4px;margin-bottom: 7px;">
        <input type="text" id="searchBar" placeholder="Search (Name, Num, Type, Egg, Ability, Species, Move)" style="width: 100%; padding: 5px; font-size: 16px; border: 2px solid #000;">
        <ul id="suggestions"></ul>
    </div>
    
    <div class="main-action-buttons" style="display:flex; align-items:center; gap:6px;">
  
        <button class="toggle-stats" onclick="toggleStats()">Show/Hide Stats</button>
        <button id="loadMovesButton" onclick="loadLearnsetData()">Load Moves</button>
      
        <div style="margin-left:auto;">
          <button class="clear-button" onclick="clearAllFilters()" 
            style="font-weight:bold; font-size:11px; padding:2px 4px;">
            RESET FILTERS
          </button>
        </div>
      
      </div>
      
    
    
    <div class="active-filters" id="activeFilters">
      <h3>Active Filters:</h3>
      <div id="activeFiltersList">
        <span class="no-filters">None</span>
      </div>
    </div>
    
    <div id="collapsibleFilterWrapper">
      <h3 id="filterToggleHeader" style="cursor: pointer; background: #eee; padding: 2px; margin-bottom: 5px;">Filters: Click to Toggle [+]</h3>
      <div class="filter-container" id="mainFilterContainer">
        
        <div class="filter-group" onclick="toggleFilterSection('typeFilters')">
          <h3>Types (AND): [+]</h3>
          <div class="filter-options" id="typeFilters"></div>
        </div>
        
        <div class="filter-group" onclick="toggleFilterSection('regionFilters')">
          <h3>Regions (OR): [+]</h3>
          <div class="filter-options" id="regionFilters"></div>
        </div>
        
        <div class="filter-group" onclick="toggleFilterSection('colorFilters')">
          <h3>Colors (OR): [+]</h3>
          <div class="filter-options" id="colorFilters"></div>
        </div>
       
        <div class="filter-group" onclick="toggleFilterSection('shapeFilters')">
          <h3>Shapes (OR): [+]</h3>
          <div class="filter-options" id="shapeFilters"></div>
        </div>
        
        <div class="filter-group" onclick="toggleFilterSection('eggGroupFilters')">
          <h3>Egg Groups (AND): [+]</h3>
          <div class="filter-options" id="eggGroupFilters"></div>
        </div>
  
        <div class="filter-group variant-filter-group" onclick="toggleFilterSection('variantExcludeFilters')">
          <h3 class="collapsible-header">Hide Forms: [+]</h3>
          <div class="filter-options" id="variantExcludeFilters"></div>
        </div>

        <div class="filter-group" id="movesFilterGroup" style="display:none;" onclick="toggleFilterSection('moveMethodFilters')">
          <h3>Move Method Filters: [+]</h3>
          <div class="filter-options" id="moveMethodFilters">
            <button id="toggle-EggButton" onclick="event.stopPropagation(); toggleLearnMethod('Egg')" class="selected">Egg</button>
            <button id="toggle-TMButton" onclick="event.stopPropagation(); toggleLearnMethod('TM')">TM</button>
            <button id="toggle-TutorButton" onclick="event.stopPropagation(); toggleLearnMethod('Tutor')">Tu</button>
            <button id="toggle-VCButton" onclick="event.stopPropagation(); toggleLearnMethod('VC')">VC</button>
          </div>
        </div>
      
      </div>
    </div>

    <div class="controls">
        <h3 id="sortHeader">Sort:</h3>
        <button data-sort="name" onclick="handleSort('name')">Name</button>
        <button data-sort="number" onclick="handleSort('number')">Number</button>
        <button data-sort="type" onclick="handleSort('type')">Type</button>
        <button data-sort="color" onclick="handleSort('color')">Color</button>
        <button data-sort="shape" onclick="handleSort('shape')">Shape</button>
        <button data-sort="height" onclick="handleSort('height')">Size</button>
        <button id="moveLevelSortButton" data-sort="movelevel" onclick="handleSort('movelevel')" style="display:none;">Move Level</button>
    </div>

  <div class="pokemon-container" id="pokemonContainer">
    <div class="no-results">Loading Pokémon data...</div>
  </div>
  
  <script src="pokemon-data.js"></script>
  <script>
   
// Moveset global variables
let learnsetLoaded = false;
let pokemonMovesExpanded = {}; // Track which pokemon have moves expanded

const pokemonGenerations = {
  1: { start: 1, end: 151.999, region: "Kanto" },
  2: { start: 152, end: 251.999, region: "Johto" },
  3: { start: 252, end: 386.999, region: "Hoenn" },
  4: { start: 387, end: 493.999, region: "Sinnoh" },
  5: { start: 494, end: 649.999, region: "Unova" },
  6: { start: 650, end: 721.999, region: "Kalos" },
  7: { start: 722, end: 809.999, region: "Alola" },
  8: { start: 810, end: 898.999, region: "Galar" },
  10: { start: 899, end: 905.999, region: "Hisui" },
  9: { start: 906, end: 1010.999, region: "Paldea" },
  10.1: { start: 1011, end: 1019.999, region: "Kitakami" },
  9.1: { start: 1020, end: 1025.099, region: "Paldea" },
  10.2: { start: 1025.1, end: 9999, region: "Kitakami" }
};

const specialForms = {
  "Alola": "Alola", "Galar": "Galar", "Hisuian": "Hisui", "Hisui": "Hisui",
  "Paldean": "Paldea", "Kitakami": "Kitakami", "Bloodmoon": "Kitakami", "Mask": "Kitakami","Origin": "Hisui", "White-Striped": "Hisui"
};

let nameToKeyMap = {};

function initializeNameKeyMap() {
    nameToKeyMap = {};
    const simpleNameKeys = new Set();

    Object.keys(pokemonData).forEach(key => {
        const pokemon = pokemonData[key];
        const nameTrimmed = pokemon.name.trim();

        nameToKeyMap[key] = key;

        if (Math.floor(pokemon.num) === pokemon.num && !pokemon.baseSpecies) {
             nameToKeyMap[nameTrimmed] = key;
             nameToKeyMap[nameTrimmed.toLowerCase()] = key;
             simpleNameKeys.add(nameTrimmed);
        }
    });

    Object.keys(pokemonData).forEach(key => {
        const pokemon = pokemonData[key];
        const nameTrimmed = pokemon.name.trim();

        if (!simpleNameKeys.has(nameTrimmed)) {
            nameToKeyMap[nameTrimmed] = key;
            nameToKeyMap[nameTrimmed.toLowerCase()] = key;
        }

        if (pokemon.baseSpecies) {
            const baseNameTrimmed = pokemon.baseSpecies.trim();
            nameToKeyMap[baseNameTrimmed] = nameToKeyMap[baseNameTrimmed] || key;
            nameToKeyMap[baseNameTrimmed.toLowerCase()] = nameToKeyMap[baseNameTrimmed.toLowerCase()] || key;
        }

        if (pokemon.forme) {
            const baseNameToUse = pokemon.baseSpecies ? pokemon.baseSpecies.trim() : nameTrimmed;
            const formeLinkName = pokemon.forme.replace(/ian$/, '').trim();

            nameToKeyMap[`${baseNameToUse}-${formeLinkName}`] = key;
            nameToKeyMap[`${baseNameToUse}-${formeLinkName}`.toLowerCase()] = key;
            
            nameToKeyMap[`${baseNameToUse}-${pokemon.forme.trim()}`] = key;
            nameToKeyMap[`${baseNameToUse}-${pokemon.forme.trim()}`.toLowerCase()] = key;
        }
    });
}

function getRegion(num) {
  for (const gen in pokemonGenerations) {
    const { start, end, region } = pokemonGenerations[gen];
    if (num >= start && num <= end) return region;
  }
  return "Unknown";
}

function getSpecialRegion(name) {
  for (const key in specialForms) {
    if (name.includes(key)) return specialForms[key];
  }
  return null;
}

function assignRegions(pokemonData) {
  for (const key in pokemonData) {
    const pokemon = pokemonData[key];
    const specialRegion = getSpecialRegion(pokemon.name);
    pokemon.region = specialRegion || getRegion(pokemon.num);
  }
}

function extractAbilities(abilitiesObj) {
  if (!abilitiesObj) return [];
  if (Array.isArray(abilitiesObj)) return abilitiesObj;
  const abilities = [];
  for (const key in abilitiesObj) {
    abilities.push(abilitiesObj[key]);
  }
  return abilities;
}

function getShapeName(shapeNum) {
  const shapeNames = {
    1: "Round", 2: "Serpent", 3: "Fins", 4: "Arms", 5: "Upright", 6: "Tailed",
    7: "Legs", 8: "4-Legs", 9: "Wings", 10: "Tentacle", 11: "Multi", 12: "Bipedal",
    13: "4-Wings", 14: "Crawling"
  };
  return shapeNames[shapeNum] || `Shape ${shapeNum}`;
}

const allTypes = ["Bug", "Dragon", "Fairy", "Fire", "Ghost", "Ground", "Normal", "Psychic", "Steel", "Dark", "Electric", "Fighting", "Flying", "Grass", "Ice", "Poison", "Rock", "Water"];
const allRegions = ["Kanto", "Johto", "Hoenn", "Sinnoh", "Unova", "Kalos", "Alola", "Galar", "Hisui", "Paldea" , "Kitakami"];

function getAllColors() {
  const colors = new Set();
  Object.values(pokemonData).forEach(pokemon => { if (pokemon.color) colors.add(pokemon.color); });
  return Array.from(colors).sort();
}
function getAllVariantTypes() {
  return ["Minor", "Item", "Gmax", "Mega",  "Battle",  "Natural"];
}
function getAllShapes() {
  const shapes = new Set();
  Object.values(pokemonData).forEach(pokemon => {
    if (pokemon.shape) {
      const shapeName = typeof pokemon.shape === 'number' ? getShapeName(pokemon.shape) : pokemon.shape;
      shapes.add(shapeName);
    }
  });
  return Array.from(shapes).sort();
}
function getAllEggGroups() {
  const eggGroups = new Set();
  Object.values(pokemonData).forEach(pokemon => {
    if (pokemon.eggGroups && Array.isArray(pokemon.eggGroups)) {
      pokemon.eggGroups.forEach(group => eggGroups.add(group));
    }
  });
  return Array.from(eggGroups).sort();
}

function getAllSpecies() {
  const species = new Set();
  Object.values(pokemonData).forEach(pokemon => {
    if (pokemon.species) species.add(pokemon.species);
  });
  return Array.from(species).sort();
}

function getAllSpeciesSearchTerms() {
  const words = new Set();
  const allSpecies = getAllSpecies(); 
  
  allSpecies.forEach(species => {
    if (species.includes(' ')) {
      words.add(species);
    }
    species.split(' ').forEach(word => {
        if (word.length > 2) { 
             words.add(word);
        }
    });
  });
  
  return Array.from(words).sort((a, b) => a.localeCompare(b)).map(s => s.charAt(0).toUpperCase() + s.slice(1));
}

function getAllAbilities() {
  const abilities = new Set();
  Object.values(pokemonData).forEach(pokemon => {
    extractAbilities(pokemon.abilities).forEach(ability => abilities.add(ability));
  });
  return Array.from(abilities).sort();
}

function extractMoves(learnset) {
    if (!learnset) return [];
    return Object.keys(learnset);
}

function getAllMoves() {
    const moves = new Set();
    if (learnsetLoaded) {
        Object.values(pokemonData).forEach(pokemon => {
            if (pokemon.learnset) {
                const pokemonMoves = extractMoves(pokemon.learnset);
                pokemonMoves.forEach(move => moves.add(move));
            }
        });
    }
    return Array.from(moves).sort();
}

function getGroupingKey(name) {
    let baseName = name.trim(); 
    if (baseName.includes('-')) {
        baseName = baseName.split('-')[0];
    } else if (baseName.includes(' ')) {
        const parts = baseName.split(' ');
        baseName = parts[parts.length - 1]; 
    }
    return baseName.toLowerCase();
}

function getPokemonKey(pokemon) {
    for (const key in pokemonData) {
        if (pokemonData[key] === pokemon) {
            return key;
        }
    }
    return null; 
}

function findFullEvolutionChainKeys(pokemonKey) {
    const chainKeys = new Set();
    const queue = [pokemonKey];
    
    while (queue.length > 0) {
        const currentKey = queue.shift();
        if (chainKeys.has(currentKey)) continue;
        
        const pokemon = pokemonData[currentKey];
        if (!pokemon) continue;
        
        chainKeys.add(currentKey);

        let relativesToProcess = [];

        if (pokemon.prevo) relativesToProcess.push(pokemon.prevo);
        if (pokemon.evos) relativesToProcess.push(...pokemon.evos);
        if (pokemon.prevos) relativesToProcess.push(...pokemon.prevos);
        
        relativesToProcess
            .filter(name => name)
            .forEach(name => {
                const normalizedName = name.trim();
                const key = nameToKeyMap[normalizedName] || nameToKeyMap[normalizedName.toLowerCase()];
                
                if (key && !chainKeys.has(key)) {
                    queue.push(key);
                }
            });

        const baseName = (pokemon.baseSpecies || pokemon.name).trim();
        const basePokemonKey = nameToKeyMap[baseName] || nameToKeyMap[baseName.toLowerCase()];

        if (basePokemonKey) {
            if (!chainKeys.has(basePokemonKey)) queue.push(basePokemonKey);

            const basePokemon = pokemonData[basePokemonKey];
            if (basePokemon) {
                const allFormeKeys = (basePokemon.formeOrder || basePokemon.otherFormes || []);
                allFormeKeys.filter(k => !chainKeys.has(k) && pokemonData[k]).forEach(k => queue.push(k));
            }
            
            Object.keys(pokemonData).filter(k => {
                const p = pokemonData[k];
                return p.baseSpecies && p.baseSpecies.trim() === baseName && !chainKeys.has(k);
            }).forEach(k => queue.push(k));
        }
    }
    
    return Array.from(chainKeys);
}

let activeFilters = {
  types: [], regions: [], colors: [], shapes: [], abilities: [], eggGroups: [], variantExclude: [], moves: []
};

let secondaryFilter = {
    type: null, 
    value: null, 
    displayValue: null, 
    selectedKey: null 
};

const filterConstraints = {
  types: 2, regions: null, eggGroups: 2, abilities: 2, colors: null, shapes: null, variantExclude: 6, moves: 10
};

let statsVisible = false;
let searchableTerms = [];
let currentSort = {
    key: 'number',
    direction: 1 
};

// Settings state
let displaySettings = {
    baseFontSize: 10,
    showNumber: true,
    showName: true,
    showSpecies: true,
    types: { desc: 'full', display: 'default' },
    region: { desc: 'short', display: 'default' },
    color: { desc: 'short', display: 'default' },
    shape: { desc: 'short', display: 'default' },
    egg: { desc: 'full', display: 'default' },
    abilities: { desc: 'full', display: 'default' }
};

// Settings icon long press
let settingsPressTimer = null;

// Moveset global variables - add egg move filter
let showEggMoves = true;
let showTMMoves = false;
let showTutorMoves = false;
let showVCMoves = false;

function clearSecondaryFilter() {
    secondaryFilter.type = null;
    secondaryFilter.value = null;
    secondaryFilter.displayValue = null;
    secondaryFilter.selectedKey = null;

    const searchBar = document.getElementById('searchBar');
    if (searchBar) searchBar.value = '';
    
    const suggestionsList = document.getElementById('suggestions');
    if (suggestionsList) suggestionsList.innerHTML = '';

    renderPokemonList();
    updateActiveFilters();
    updateSortButtons();
}

function toggleFilter(filterType, value) {
  if (secondaryFilter.type) {
    clearSecondaryFilter();
  }

  if (activeFilters[filterType].includes(value)) {
    activeFilters[filterType] = activeFilters[filterType].filter(item => item !== value);
  } else {
    if (filterConstraints[filterType] !== null && 
        activeFilters[filterType].length >= filterConstraints[filterType]) {
      activeFilters[filterType].shift();
    }
    activeFilters[filterType].push(value);
  }
  updateFilterUI(filterType);
  renderPokemonList();
  updateActiveFilters();
  updateSortButtons();
  document.getElementById('searchBar').value = ''; 
  document.getElementById('suggestions').innerHTML = '';
  
  // Show/hide Move Level sort button based on move filters
  const moveLevelButton = document.getElementById('moveLevelSortButton');
  if (moveLevelButton) {
    moveLevelButton.style.display = activeFilters.moves.length > 0 ? 'inline-block' : 'none';
  }
}

function updateFilterUI(filterType) {
  const selector = filterType === 'types' ? '[data-type]' :
                   filterType === 'regions' ? '[data-region]' :
                   filterType === 'colors' ? '[data-color]' :
                   filterType === 'variantExclude' ? '[data-variant]' :
                   filterType === 'shapes' ? '[data-shape]' :
                   filterType === 'eggGroups' ? '[data-egggroup]' :
                   filterType === 'moves' ? '[data-move]' : '';
  
  if (selector) {
    document.querySelectorAll(`.filter-chip${selector}`).forEach(chip => {
      const attr = selector.replace(/[\[\]]/g, '');
      const value = chip.getAttribute(attr);
      chip.classList.toggle('selected', activeFilters[filterType].includes(value));
    });
  }
}

function updateActiveFilters() {
  const activeFiltersList = document.getElementById('activeFiltersList');
  activeFiltersList.innerHTML = '';
  
  let hasFilters = false;
  
  if (secondaryFilter.type) {
      const filterLabel = secondaryFilter.type === 'secondary-name' ? 'name' :
                          secondaryFilter.type === 'secondary-num' ? 'num' : 
                          'species';
      const chipHtml = `<span class="active-filter-chip" onclick="clearSecondaryFilter()">${filterLabel}_${secondaryFilter.displayValue} <span class="remove">x</span></span><span class="filter-separator">; </span>`;
      activeFiltersList.innerHTML += chipHtml;
      hasFilters = true;
  }
  
  const filterTypeMap = {
    'types': 'type',
    'regions': 'region',
    'colors': 'color',
    'shapes': 'shape',
    'eggGroups': 'egg',
    'abilities': 'ability',
    'moves': 'move',
    'variantExclude': 'variantExcl'
  };
  
  for (const [filterType, values] of Object.entries(activeFilters)) {
    if (values.length > 0) {
      hasFilters = true;
      values.forEach(value => {
        const displayType = filterTypeMap[filterType] || filterType.toLowerCase();
        const displayValue = filterType === 'moves' ? formatMoveName(value) : value;
        const chipHtml = `<span class="active-filter-chip" onclick="toggleFilter('${filterType}', '${value}')">${displayType}_${displayValue} <span class="remove">x</span></span><span class="filter-separator">; </span>`;
        activeFiltersList.innerHTML += chipHtml;
      });
    }
  }
  
  if (!hasFilters) {
    activeFiltersList.innerHTML = '<span class="no-filters">None</span>';
  }
}

function clearAllFilters() {
  for (const filterType in activeFilters) {
    activeFilters[filterType] = [];
  }
  clearSecondaryFilter();
  document.querySelectorAll('.filter-chip').forEach(chip => {
    chip.classList.remove('selected');
  });
  renderPokemonList();
  updateActiveFilters();
  updateSortButtons();
}

function getTypesHTML(types) {
  if (!types || types.length === 0) return 'Types: N/A';
  
  const settings = displaySettings.types;
  if (settings.display === 'hide') return '';
  
  let prefix = '';
  if (settings.desc === 'full') prefix = 'Types: ';
  else if (settings.desc === 'short') prefix = 'T: ';
  
  const typesList = types.map(type => {
    const isSelected = activeFilters.types.includes(type);
    const className = isSelected ? 'clickable selected-result' : 'clickable';
    
    if (settings.display === 'color') {
      const typeColors = {
        Bug: '#A8B820', Dragon: '#7038F8', Fairy: '#EE99AC', Fire: '#F08030',
        Ghost: '#705898', Ground: '#E0C068', Normal: '#A8A878', Psychic: '#F85888',
        Steel: '#B8B8D0', Dark: '#705848', Electric: '#F8D030', Fighting: '#C03028',
        Flying: '#A890F0', Grass: '#78C850', Ice: '#98D8D8', Poison: '#A040A0',
        Rock: '#B8A038', Water: '#6890F0'
      };
      const bgColor = typeColors[type] || '#ccc';
      return `<span class="${className}" data-filter-type="types" data-filter-value="${type}" style="background-color: ${bgColor}; color: white; padding: 2px 4px;">${type}</span>`;
    }
    
    return `<span class="${className}" data-filter-type="types" data-filter-value="${type}">${type}</span>`;
  }).join(' / ');
  
  return prefix + typesList;
}

function getAbilitiesHTML(abilitiesObj) {
  const abilities = extractAbilities(abilitiesObj);
  if (abilities.length === 0) return 'N/A';
  
  const settings = displaySettings.abilities;
  if (settings.display === 'hide') return '';
  
  let prefix = '';
  if (settings.desc === 'full') prefix = 'Abilities: ';
  else if (settings.desc === 'short') prefix = 'A: ';
  
  let html = '';
  abilities.forEach((ability, index) => {
    const isSelected = activeFilters.abilities.includes(ability);
    const className = isSelected ? 'clickable selected-result' : 'clickable';
    
    if (settings.display === 'color') {
      html += `<span class="${className}" data-filter-type="abilities" data-filter-value="${ability}" style="background-color: #9C7EBF; color: white; padding: 2px 4px;">${ability}</span>${index < abilities.length - 1 ? ' / ' : ''}`;
    } else {
      html += `<span class="${className}" data-filter-type="abilities" data-filter-value="${ability}">${ability}</span>${index < abilities.length - 1 ? ' / ' : ''}`;
    }
  });
  
  return prefix + html;
}

function getEggGroupsHTML(eggGroups) {
  if (!eggGroups || eggGroups.length === 0) return 'Egg: N/A';
  
  const settings = displaySettings.egg;
  if (settings.display === 'hide') return '';
  
  let prefix = '';
  if (settings.desc === 'full') prefix = 'Egg: ';
  else if (settings.desc === 'short') prefix = 'E: ';
  
  const groupsList = eggGroups.map(group => {
    const isSelected = activeFilters.eggGroups.includes(group);
    const className = isSelected ? 'clickable selected-result' : 'clickable';
    
    if (settings.display === 'color') {
      return `<span class="${className}" data-filter-type="eggGroups" data-filter-value="${group}" style="background-color: #FFA07A; color: white; padding: 2px 4px;">${group.replace(' ', '')}</span>`;
    }
    
    return `<span class="${className}" data-filter-type="eggGroups" data-filter-value="${group}">${group.replace(' ', '')}</span>`;
  }).join(' / ');
  
  return prefix + groupsList;
}

// Dictionary of special cases for multi-word moves
const moveDisplayNames = {
    "karatechop": "Karate Chop",
    "doubleslap": "Double Slap",
    "cometpunch": "Comet Punch",
    "megapunch": "Mega Punch",
    "payday": "Pay Day",
    "firepunch": "Fire Punch",
    "icepunch": "Ice Punch",
    "thunderpunch": "Thunder Punch",
    "visegrip": "Vise Grip",
    "razorwind": "Razor Wind",
    "swordsdance": "Swords Dance",
    "wingattack": "Wing Attack",
    "vinewhip": "Vine Whip",
    "doublekick": "Double Kick",
    "megakick": "Mega Kick",
    "jumpkick": "Jump Kick",
    "rollingkick": "Rolling Kick",
    "sandattack": "Sand Attack",
    "hornattack": "Horn Attack",
    "furyattack": "Fury Attack",
    "horndrill": "Horn Drill",
    "bodyslam": "Body Slam",
    "takedown": "Take Down",
    "tailwhip": "Tail Whip",
    "poisonsting": "Poison Sting",
    "pinmissile": "Pin Missile",
    "sonicboom": "Sonic Boom",
    "watergun": "Water Gun",
    "hydropump": "Hydro Pump",
    "icebeam": "Ice Beam",
    "bubblebeam": "Bubble Beam",
    "aurorabeam": "Aurora Beam",
    "hyperbeam": "Hyper Beam",
    "drillpeck": "Drill Peck",
    "lowkick": "Low Kick",
    "seismictoss": "Seismic Toss",
    "megadrain": "Mega Drain",
    "leechseed": "Leech Seed",
    "razorleaf": "Razor Leaf",
    "solarbeam": "Solar Beam",
    "poisonpowder": "Poison Powder",
    "stunspore": "Stun Spore",
    "sleeppowder": "Sleep Powder",
    "petaldance": "Petal Dance",
    "stringshot": "String Shot",
    "dragonrage": "Dragon Rage",
    "firespin": "Fire Spin",
    "thundershock": "Thunder Shock",
    "thunderwave": "Thunder Wave",
    "rockthrow": "Rock Throw",
    "quickattack": "Quick Attack",
    "nightshade": "Night Shade",
    "doubleteam": "Double Team",
    "confuseray": "Confuse Ray",
    "defensecurl": "Defense Curl",
    "lightscreen": "Light Screen",
    "focusenergy": "Focus Energy",
    "mirrormove": "Mirror Move",
    "eggbomb": "Egg Bomb",
    "boneclub": "Bone Club",
    "fireblast": "Fire Blast",
    "skullbash": "Skull Bash",
    "spikecannon": "Spike Cannon",
    "highjumpkick": "High Jump Kick",
    "dreameater": "Dream Eater",
    "poisongas": "Poison Gas",
    "leechlife": "Leech Life",
    "lovelykiss": "Lovely Kiss",
    "skyattack": "Sky Attack",
    "dizzypunch": "Dizzy Punch",
    "acidarmor": "Acid Armor",
    "furyswipes": "Fury Swipes",
    "rockslide": "Rock Slide",
    "hyperfang": "Hyper Fang",
    "triattack": "Tri Attack",
    "superfang": "Super Fang",
    "triplekick": "Triple Kick",
    "spiderweb": "Spider Web",
    "mindreader": "Mind Reader",
    "flamewheel": "Flame Wheel",
    "conversion2": "Conversion 2",
    "cottonspore": "Cotton Spore",
    "powdersnow": "Powder Snow",
    "machpunch": "Mach Punch",
    "scaryface": "Scary Face",
    "feintattack": "Feint Attack",
    "sweetkiss": "Sweet Kiss",
    "bellydrum": "Belly Drum",
    "sludgebomb": "Sludge Bomb",
    "zapcannon": "Zap Cannon",
    "destinybond": "Destiny Bond",
    "perishsong": "Perish Song",
    "icywind": "Icy Wind",
    "bonerush": "Bone Rush",
    "gigadrain": "Giga Drain",
    "falseswipe": "False Swipe",
    "milkdrink": "Milk Drink",
    "furycutter": "Fury Cutter",
    "steelwing": "Steel Wing",
    "meanlook": "Mean Look",
    "sleeptalk": "Sleep Talk",
    "healbell": "Heal Bell",
    "painsplit": "Pain Split",
    "sacredfire": "Sacred Fire",
    "dynamicpunch": "Dynamic Punch",
    "dragonbreath": "Dragon Breath",
    "batonpass": "Baton Pass",
    "rapidspin": "Rapid Spin",
    "sweetscent": "Sweet Scent",
    "irontail": "Iron Tail",
    "metalclaw": "Metal Claw",
    "vitalthrow": "Vital Throw",
    "morningsun": "Morning Sun",
    "hiddenpower": "Hidden Power",
    "crosschop": "Cross Chop",
    "raindance": "Rain Dance",
    "sunnyday": "Sunny Day",
    "mirrorcoat": "Mirror Coat",
    "psychup": "Psych Up",
    "extremespeed": "Extreme Speed",
    "ancientpower": "Ancient Power",
    "shadowball": "Shadow Ball",
    "futuresight": "Future Sight",
    "rocksmash": "Rock Smash",
    "beatup": "Beat Up",
    "fakeout": "Fake Out",
    "spitup": "Spit Up",
    "heatwave": "Heat Wave",
    "focuspunch": "Focus Punch",
    "smellingsalts": "Smelling Salts",
    "followme": "Follow Me",
    "naturepower": "Nature Power",
    "helpinghand": "Helping Hand",
    "roleplay": "Role Play",
    "magiccoat": "Magic Coat",
    "brickbreak": "Brick Break",
    "knockoff": "Knock Off",
    "skillswap": "Skill Swap",
    "secretpower": "Secret Power",
    "armthrust": "Arm Thrust",
    "tailglow": "Tail Glow",
    "lusterpurge": "Luster Purge",
    "mistball": "Mist Ball",
    "featherdance": "Feather Dance",
    "teeterdance": "Teeter Dance",
    "blazekick": "Blaze Kick",
    "mudsport": "Mud Sport",
    "iceball": "Ice Ball",
    "needlearm": "Needle Arm",
    "slackoff": "Slack Off",
    "hypervoice": "Hyper Voice",
    "poisonfang": "Poison Fang",
    "crushclaw": "Crush Claw",
    "blastburn": "Blast Burn",
    "hydrocannon": "Hydro Cannon",
    "meteormash": "Meteor Mash",
    "weatherball": "Weather Ball",
    "faketears": "Fake Tears",
    "aircutter": "Air Cutter",
    "odorsleuth": "Odor Sleuth",
    "rocktomb": "Rock Tomb",
    "silverwind": "Silver Wind",
    "metalsound": "Metal Sound",
    "grasswhistle": "Grass Whistle",
    "cosmicpower": "Cosmic Power",
    "waterspout": "Water Spout",
    "signalbeam": "Signal Beam",
    "shadowpunch": "Shadow Punch",
    "skyuppercut": "Sky Uppercut",
    "sandtomb": "Sand Tomb",
    "sheercold": "Sheer Cold",
    "muddywater": "Muddy Water",
    "bulletseed": "Bullet Seed",
    "aerialace": "Aerial Ace",
    "iciclespear": "Icicle Spear",
    "irondefense": "Iron Defense",
    "dragonclaw": "Dragon Claw",
    "frenzyplant": "Frenzy Plant",
    "bulkup": "Bulk Up",
    "mudshot": "Mud Shot",
    "poisontail": "Poison Tail",
    "volttackle": "Volt Tackle",
    "magicalleaf": "Magical Leaf",
    "watersport": "Water Sport",
    "calmmind": "Calm Mind",
    "leafblade": "Leaf Blade",
    "dragondance": "Dragon Dance",
    "rockblast": "Rock Blast",
    "shockwave": "Shock Wave",
    "waterpulse": "Water Pulse",
    "doomdesire": "Doom Desire",
    "psychoboost": "Psycho Boost",
    "miracleeye": "Miracle Eye",
    "wakeupslap": "Wake-Up Slap",
    "hammerarm": "Hammer Arm",
    "gyroball": "Gyro Ball",
    "healingwish": "Healing Wish",
    "naturalgift": "Natural Gift",
    "metalburst": "Metal Burst",
    "closecombat": "Close Combat",
    "psychoshift": "Psycho Shift",
    "trumpcard": "Trump Card",
    "healblock": "Heal Block",
    "wringout": "Wring Out",
    "powertrick": "Power Trick",
    "gastroacid": "Gastro Acid",
    "luckychant": "Lucky Chant",
    "mefirst": "Me First",
    "powerswap": "Power Swap",
    "guardswap": "Guard Swap",
    "lastresort": "Last Resort",
    "worryseed": "Worry Seed",
    "suckerpunch": "Sucker Punch",
    "toxicspikes": "Toxic Spikes",
    "heartswap": "Heart Swap",
    "aquaring": "Aqua Ring",
    "magnetrise": "Magnet Rise",
    "flareblitz": "Flare Blitz",
    "forcepalm": "Force Palm",
    "aurasphere": "Aura Sphere",
    "rockpolish": "Rock Polish",
    "poisonjab": "Poison Jab",
    "darkpulse": "Dark Pulse",
    "nightslash": "Night Slash",
    "aquatail": "Aqua Tail",
    "seedbomb": "Seed Bomb",
    "airslash": "Air Slash",
    "bugbuzz": "Bug Buzz",
    "dragonpulse": "Dragon Pulse",
    "dragonrush": "Dragon Rush",
    "powergem": "Power Gem",
    "drainpunch": "Drain Punch",
    "vacuumwave": "Vacuum Wave",
    "focusblast": "Focus Blast",
    "energyball": "Energy Ball",
    "bravebird": "Brave Bird",
    "earthpower": "Earth Power",
    "gigaimpact": "Giga Impact",
    "nastyplot": "Nasty Plot",
    "bulletpunch": "Bullet Punch",
    "iceshard": "Ice Shard",
    "shadowclaw": "Shadow Claw",
    "thunderfang": "Thunder Fang",
    "icefang": "Ice Fang",
    "firefang": "Fire Fang",
    "shadowsneak": "Shadow Sneak",
    "mudbomb": "Mud Bomb",
    "psychocut": "Psycho Cut",
    "zenheadbutt": "Zen Headbutt",
    "mirrorshot": "Mirror Shot",
    "flashcannon": "Flash Cannon",
    "rockclimb": "Rock Climb",
    "trickroom": "Trick Room",
    "dracometeor": "Draco Meteor",
    "lavaplume": "Lava Plume",
    "leafstorm": "Leaf Storm",
    "powerwhip": "Power Whip",
    "rockwrecker": "Rock Wrecker",
    "crosspoison": "Cross Poison",
    "gunkshot": "Gunk Shot",
    "ironhead": "Iron Head",
    "magnetbomb": "Magnet Bomb",
    "stoneedge": "Stone Edge",
    "stealthrock": "Stealth Rock",
    "grassknot": "Grass Knot",
    "bugbite": "Bug Bite",
    "chargebeam": "Charge Beam",
    "woodhammer": "Wood Hammer",
    "aquajet": "Aqua Jet",
    "attackorder": "Attack Order",
    "defendorder": "Defend Order",
    "healorder": "Heal Order",
    "headsmash": "Head Smash",
    "doublehit": "Double Hit",
    "roaroftime": "Roar of Time",
    "spacialrend": "Spacial Rend",
    "lunardance": "Lunar Dance",
    "crushgrip": "Crush Grip",
    "magmastorm": "Magma Storm",
    "darkvoid": "Dark Void",
    "seedflare": "Seed Flare",
    "ominouswind": "Ominous Wind",
    "shadowforce": "Shadow Force",
    "honeclaws": "Hone Claws",
    "wideguard": "Wide Guard",
    "guardsplit": "Guard Split",
    "powersplit": "Power Split",
    "wonderroom": "Wonder Room",
    "ragepowder": "Rage Powder",
    "magicroom": "Magic Room",
    "smackdown": "Smack Down",
    "stormthrow": "Storm Throw",
    "flameburst": "Flame Burst",
    "sludgewave": "Sludge Wave",
    "quiverdance": "Quiver Dance",
    "heavyslam": "Heavy Slam",
    "electroball": "Electro Ball",
    "flamecharge": "Flame Charge",
    "lowsweep": "Low Sweep",
    "acidspray": "Acid Spray",
    "foulplay": "Foul Play",
    "simplebeam": "Simple Beam",
    "afteryou": "After You",
    "echoedvoice": "Echoed Voice",
    "chipaway": "Chip Away",
    "clearsmog": "Clear Smog",
    "storedpower": "Stored Power",
    "quickguard": "Quick Guard",
    "allyswitch": "Ally Switch",
    "shellsmash": "Shell Smash",
    "healpulse": "Heal Pulse",
    "skydrop": "Sky Drop",
    "shiftgear": "Shift Gear",
    "circlethrow": "Circle Throw",
    "reflecttype": "Reflect Type",
    "finalgambit": "Final Gambit",
    "waterpledge": "Water Pledge",
    "firepledge": "Fire Pledge",
    "grasspledge": "Grass Pledge",
    "voltswitch": "Volt Switch",
    "strugglebug": "Struggle Bug",
    "frostbreath": "Frost Breath",
    "dragontail": "Dragon Tail",
    "workup": "Work Up",
    "wildcharge": "Wild Charge",
    "drillrun": "Drill Run",
    "dualchop": "Dual Chop",
    "heartstamp": "Heart Stamp",
    "hornleech": "Horn Leech",
    "sacredsword": "Sacred Sword",
    "razorshell": "Razor Shell",
    "heatcrash": "Heat Crash",
    "leaftornado": "Leaf Tornado",
    "cottonguard": "Cotton Guard",
    "nightdaze": "Night Daze",
    "tailslap": "Tail Slap",
    "headcharge": "Head Charge",
    "geargrind": "Gear Grind",
    "searingshot": "Searing Shot",
    "technoblast": "Techno Blast",
    "relicsong": "Relic Song",
    "secretsword": "Secret Sword",
    "boltstrike": "Bolt Strike",
    "blueflare": "Blue Flare",
    "fierydance": "Fiery Dance",
    "freezeshock": "Freeze Shock",
    "iceburn": "Ice Burn",
    "iciclecrash": "Icicle Crash",
    "fusionflare": "Fusion Flare",
    "fusionbolt": "Fusion Bolt",
    "flyingpress": "Flying Press",
    "matblock": "Mat Block",
    "stickyweb": "Sticky Web",
    "fellstinger": "Fell Stinger",
    "phantomforce": "Phantom Force",
    "nobleroar": "Noble Roar",
    "iondeluge": "Ion Deluge",
    "paraboliccharge": "Parabolic Charge",
    "forest'scurse": "Forest's Curse",
    "petalblizzard": "Petal Blizzard",
    "disarmingvoice": "Disarming Voice",
    "partingshot": "Parting Shot",
    "drainingkiss": "Draining Kiss",
    "craftyshield": "Crafty Shield",
    "flowershield": "Flower Shield",
    "grassyterrain": "Grassy Terrain",
    "mistyterrain": "Misty Terrain",
    "playrough": "Play Rough",
    "fairywind": "Fairy Wind",
    "fairylock": "Fairy Lock",
    "kingsshield": "King's Shield",
    "playnice": "Play Nice",
    "diamondstorm": "Diamond Storm",
    "steameruption": "Steam Eruption",
    "hyperspacehole": "Hyperspace Hole",
    "watershuriken": "Water Shuriken",
    "mysticalfire": "Mystical Fire",
    "spikyshield": "Spiky Shield",
    "aromaticmist": "Aromatic Mist",
    "eerieimpulse": "Eerie Impulse",
    "venomdrench": "Venom Drench",
    "magneticflux": "Magnetic Flux",
    "happyhour": "Happy Hour",
    "electricterrain": "Electric Terrain",
    "dazzlinggleam": "Dazzling Gleam",
    "holdhands": "Hold Hands",
    "baby-dolleyes": "Baby-Doll Eyes",
    "holdback": "Hold Back",
    "power-uppunch": "Power-Up Punch",
    "oblivionwing": "Oblivion Wing",
    "thousandarrows": "Thousand Arrows",
    "thousandwaves": "Thousand Waves",
    "land'swrath": "Land's Wrath",
    "lightofruin": "Light of Ruin",
    "originpulse": "Origin Pulse",
    "precipiceblades": "Precipice Blades",
    "dragonascent": "Dragon Ascent",
    "hyperspacefury": "Hyperspace Fury",
    "shoreup": "Shore Up",
    "firstimpression": "First Impression",
    "banefulbunker": "Baneful Bunker",
    "spiritshackle": "Spirit Shackle",
    "darkestlariat": "Darkest Lariat",
    "sparklingaria": "Sparkling Aria",
    "icehammer": "Ice Hammer",
    "floralhealing": "Floral Healing",
    "highhorsepower": "High Horsepower",
    "strengthsap": "Strength Sap",
    "solarblade": "Solar Blade",
    "toxicthread": "Toxic Thread",
    "laserfocus": "Laser Focus",
    "gearup": "Gear Up",
    "throatchop": "Throat Chop",
    "pollenpuff": "Pollen Puff",
    "anchorshot": "Anchor Shot",
    "psychicterrain": "Psychic Terrain",
    "firelash": "Fire Lash",
    "powertrip": "Power Trip",
    "burnup": "Burn Up",
    "speedswap": "Speed Swap",
    "smartstrike": "Smart Strike",
    "revelationdance": "Revelation Dance",
    "coreenforcer": "Core Enforcer",
    "tropkick": "Trop Kick",
    "beakblast": "Beak Blast",
    "clangingscales": "Clanging Scales",
    "dragonhammer": "Dragon Hammer",
    "brutalswing": "Brutal Swing",
    "auroraveil": "Aurora Veil",
    "sinisterarrowraid": "Sinister Arrow Raid",
    "maliciousmoonsault": "Malicious Moonsault",
    "oceanicoperetta": "Oceanic Operetta",
    "guardianofalola": "Guardian of Alola",
    "soulstealing7starstrike": "Soul-Stealing 7-Star Strike",
    "stokedsparksurfer": "Stoked Sparksurfer",
    "pulverizingpancake": "Pulverizing Pancake",
    "extremeevoboost": "Extreme Evoboost",
    "genesissupernova": "Genesis Supernova",
    "shelltrap": "Shell Trap",
    "fleurcannon": "Fleur Cannon",
    "psychicfangs": "Psychic Fangs",
    "stompingtantrum": "Stomping Tantrum",
    "shadowbone": "Shadow Bone",
    "prismaticlaser": "Prismatic Laser",
    "spectralthief": "Spectral Thief",
    "sunsteelstrike": "Sunsteel Strike",
    "moongeistbeam": "Moongeist Beam",
    "tearfullook": "Tearful Look",
    "zingzap": "Zing Zap",
    "naturesmadness": "Nature's Madness",
    "10000000voltthunderbolt": "10 000 000 Volt Thunderbolt",
    "mindblown": "Mind Blown",
    "plasmafists": "Plasma Fists",
    "photongeyser": "Photon Geyser",
    "lightthatburnsthesky": "Light That Burns the Sky",
    "searingsunrazesmash": "Searing Sunraze Smash",
    "menacingmoonrazemaelstrom": "Menacing Moonraze Maelstrom",
    "letssnuggleforever": "Let's Snuggle Forever",
    "splinteredstormshards": "Splintered Stormshards",
    "clangoroussoulblaze": "Clangorous Soulblaze",
    "zippyzap": "Zippy Zap",
    "splishysplash": "Splishy Splash",
    "floatyfall": "Floaty Fall",
    "pikapapow": "Pika Papow",
    "bouncybubble": "Bouncy Bubble",
    "buzzybuzz": "Buzzy Buzz",
    "sizzlyslide": "Sizzly Slide",
    "glitzyglow": "Glitzy Glow",
    "baddybad": "Baddy Bad",
    "sappyseed": "Sappy Seed",
    "freezyfrost": "Freezy Frost",
    "sparklyswirl": "Sparkly Swirl",
    "veeveevolley": "Veevee Volley",
    "doubleironbash": "Double Iron Bash",
    "maxguard": "Max Guard",
    "dynamaxcannon": "Dynamax Cannon",
    "snipeshot": "Snipe Shot",
    "jawlock": "Jaw Lock",
    "stuffcheeks": "Stuff Cheeks",
    "noretreat": "No Retreat",
    "tarshot": "Tar Shot",
    "magicpowder": "Magic Powder",
    "dragondarts": "Dragon Darts",
    "boltbeak": "Bolt Beak",
    "fishiousrend": "Fishious Rend",
    "courtchange": "Court Change",
    "clangoroussoul": "Clangorous Soul",
    "bodypress": "Body Press",
    "drumbeating": "Drum Beating",
    "snaptrap": "Snap Trap",
    "pyroball": "Pyro Ball",
    "behemothblade": "Behemoth Blade",
    "behemothbash": "Behemoth Bash",
    "aurawheel": "Aura Wheel",
    "breakingswipe": "Breaking Swipe",
    "branchpoke": "Branch Poke",
    "appleacid": "Apple Acid",
    "gravapple": "Grav Apple",
    "spiritbreak": "Spirit Break",
    "strangesteam": "Strange Steam",
    "lifedew": "Life Dew",
    "falsesurrender": "False Surrender",
    "meteorassault": "Meteor Assault",
    "steelbeam": "Steel Beam",
    "expandingforce": "Expanding Force",
    "steelroller": "Steel Roller",
    "scaleshot": "Scale Shot",
    "meteorbeam": "Meteor Beam",
    "shellsidearm": "Shell Side Arm",
    "mistyexplosion": "Misty Explosion",
    "grassyglide": "Grassy Glide",
    "risingvoltage": "Rising Voltage",
    "terrainpulse": "Terrain Pulse",
    "skittersmack": "Skitter Smack",
    "burningjealousy": "Burning Jealousy",
    "lashout": "Lash Out",
    "corrosivegas": "Corrosive Gas",
    "flipturn": "Flip Turn",
    "tripleaxel": "Triple Axel",
    "dualwingbeat": "Dual Wingbeat",
    "scorchingsands": "Scorching Sands",
    "junglehealing": "Jungle Healing",
    "wickedblow": "Wicked Blow",
    "surgingstrikes": "Surging Strikes",
    "thundercage": "Thunder Cage",
    "dragonenergy": "Dragon Energy",
    "freezingglare": "Freezing Glare",
    "fierywrath": "Fiery Wrath",
    "thunderouskick": "Thunderous Kick",
    "glaciallance": "Glacial Lance",
    "astralbarrage": "Astral Barrage",
    "eeriespell": "Eerie Spell",
    "direclaw": "Dire Claw",
    "psyshieldbash": "Psyshield Bash",
    "powershift": "Power Shift",
    "stoneaxe": "Stone Axe",
    "springtidestorm": "Springtide Storm",
    "mysticalpower": "Mystical Power",
    "ragingfury": "Raging Fury",
    "wavecrash": "Wave Crash",
    "mountaingale": "Mountain Gale",
    "victorydance": "Victory Dance",
    "headlongrush": "Headlong Rush",
    "barbbarrage": "Barb Barrage",
    "esperwing": "Esper Wing",
    "bittermalice": "Bitter Malice",
    "triplearrows": "Triple Arrows",
    "infernalparade": "Infernal Parade",
    "ceaselessedge": "Ceaseless Edge",
    "bleakwindstorm": "Bleakwind Storm",
    "wildboltstorm": "Wildbolt Storm",
    "sandsearstorm": "Sandsear Storm",
    "lunarblessing": "Lunar Blessing",
    "takeheart": "Take Heart",
    "terablast": "Tera Blast",
    "silktrap": "Silk Trap",
    "axekick": "Axe Kick",
    "lastrespects": "Last Respects",
    "luminacrash": "Lumina Crash",
    "orderup": "Order Up",
    "jetpunch": "Jet Punch",
    "spicyextract": "Spicy Extract",
    "spinout": "Spin Out",
    "populationbomb": "Population Bomb",
    "icespinner": "Ice Spinner",
    "glaiverush": "Glaive Rush",
    "revivalblessing": "Revival Blessing",
    "saltcure": "Salt Cure",
    "tripledive": "Triple Dive",
    "mortalspin": "Mortal Spin",
    "filletaway": "Fillet Away",
    "kowtowcleave": "Kowtow Cleave",
    "flowertrick": "Flower Trick",
    "torchsong": "Torch Song",
    "aquastep": "Aqua Step",
    "ragingbull": "Raging Bull",
    "makeitrain": "Make It Rain",
    "hydrosteam": "Hydro Steam",
    "collisioncourse": "Collision Course",
    "electrodrift": "Electro Drift",
    "shedtail": "Shed Tail",
    "chillyreception": "Chilly Reception",
    "tidyup": "Tidy Up",
    "chillingwater": "Chilling Water",
    "hyperdrill": "Hyper Drill",
    "twinbeam": "Twin Beam",
    "ragefist": "Rage Fist",
    "armorcannon": "Armor Cannon",
    "bitterblade": "Bitter Blade",
    "doubleshock": "Double Shock",
    "gigatonhammer": "Gigaton Hammer",
    "aquacutter": "Aqua Cutter",
    "blazingtorque": "Blazing Torque",
    "wickedtorque": "Wicked Torque",
    "noxioustorque": "Noxious Torque",
    "combattorque": "Combat Torque",
    "magicaltorque": "Magical Torque",
    "bloodmoon": "Blood Moon",
    "matchagotcha": "Matcha Gotcha",
    "syrupbomb": "Syrup Bomb",
    "ivycudgel": "Ivy Cudgel",
    "electroshot": "Electro Shot",
    "terastarstorm": "Tera Starstorm",
    "ficklebeam": "Fickle Beam",
    "burningbulwark": "Burning Bulwark",
    "mightycleave": "Mighty Cleave",
    "tachyoncutter": "Tachyon Cutter",
    "hardpress": "Hard Press",
    "dragoncheer": "Dragon Cheer",
    "alluringvoice": "Alluring Voice",
    "temperflare": "Temper Flare",
    "supercellslam": "Supercell Slam",
    "psychicnoise": "Psychic Noise",
    "upperhand": "Upper Hand",
    "malignantchain": "Malignant Chain",
    "doubleedge": "Double-Edge",
    "selfdestruct": "Self-Destruct",
    "softboiled": "Soft-Boiled",
    "mudslap": "Mud-Slap",
    "lockon": "Lock-On",
    "willowisp": "Will-O-Wisp",
    "uturn": "U-turn",
    "xscissor": "X-Scissor",
    "vcreate": "V-create",
    "trickortreat": "Trick-or-Treat",
    "freezedry": "Freeze-Dry",
    "topsyturvy": "Topsy-Turvy",
    "multiattack": "Multi-Attack"
};

function formatMoveName(moveKey) {
    // Check if we have a special case first
    if (moveDisplayNames[moveKey.toLowerCase()]) {
        return moveDisplayNames[moveKey.toLowerCase()];
    }
    
    // Otherwise, capitalize each part after splitting by hyphen
    return moveKey.split('-')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(' ');
}

function getLearnMethodText(method) {
    if (method.startsWith('L')) return `Lv.${method.substring(1)}`;

    const methodMap = {
        'M': 'TM',
        'T': 'Tu',
        'E': 'Egg',
        'S': 'Sp',
        'V': 'VC'
    };

    return methodMap[method[0]] || method;
}

function getMovesHTML(learnset, pokemonKey, showFiltered = false) {
    if (!learnsetLoaded) return '';
    if (!learnset || Object.keys(learnset).length === 0) return '';

    const moveEntries = Object.entries(learnset).slice(0, 500);
    const parts = [];

    moveEntries.forEach(([move, methods]) => {
        const displayName = move.split('-')
            .map(word => word.charAt(0).toUpperCase() + word.slice(1))
            .join(' ');

        const learnMethod = methods[0];
        const methodType = learnMethod[0];
        const methodText = getLearnMethodText(learnMethod);

        let shouldHide = false;
        if (methodType === 'E' && !showEggMoves) shouldHide = true;
        else if (methodType === 'M' && !showTMMoves) shouldHide = true;
        else if (methodType === 'T' && !showTutorMoves) shouldHide = true;
        else if (methodType === 'V' && !showVCMoves) shouldHide = true;

        const isFiltered = activeFilters.moves.includes(move);
        
        // Show move if: not hidden AND (showFiltered mode shows only filtered, or show all mode)
        if (!shouldHide) {
            if (showFiltered && !isFiltered) return; // In filtered mode, skip non-filtered moves
            
            const className = isFiltered ? 'move-item clickable selected-result' : 'move-item clickable';
            
            parts.push(`<span class="${className}" 
            data-filter-type="moves" data-filter-value="${move}">
            ${displayName} <small class="learn-method">(${methodText})</small>
            </span>`);
        }
    });

    return parts.length > 0 ? parts.join('; ') : '';
}

function togglePokemonMoves(pokemonKey) {
    pokemonMovesExpanded[pokemonKey] = !pokemonMovesExpanded[pokemonKey];
    renderPokemonList();
}

function toggleStats() {
  statsVisible = !statsVisible;
  document.querySelectorAll('.pokemon-stats').forEach(stats => {
    stats.classList.toggle('hidden', !statsVisible);
  });
}

function toggleLearnMethod(methodKey) {
    if (methodKey === 'Egg') {
        showEggMoves = !showEggMoves;
        document.getElementById('toggle-EggButton').classList.toggle('selected', showEggMoves);
    } else if (methodKey === 'TM') {
        showTMMoves = !showTMMoves;
        document.getElementById('toggle-TMButton').classList.toggle('selected', showTMMoves);
    } else if (methodKey === 'Tutor') {
        showTutorMoves = !showTutorMoves;
        document.getElementById('toggle-TutorButton').classList.toggle('selected', showTutorMoves);
    } else if (methodKey === 'VC') {
        showVCMoves = !showVCMoves;
        document.getElementById('toggle-VCButton').classList.toggle('selected', showVCMoves);
    }

    renderPokemonList();
}

function toggleFilterContainer() {
    const container = document.getElementById('mainFilterContainer');
    const header = document.getElementById('filterToggleHeader');
    container.classList.toggle('expanded');
    
    if (container.classList.contains('expanded')) {
        header.textContent = 'Filters: Click to Toggle [-]';
    } else {
        header.textContent = 'Filters: Click to Toggle [+]';
    }
}

function toggleFilterSection(sectionId) {
    const section = document.getElementById(sectionId);
    const parentGroup = section.parentElement;
    const header = parentGroup.querySelector('h3');
    
    section.classList.toggle('expanded');
    
    if (section.classList.contains('expanded')) {
        // Update header text to show [-]
        header.textContent = header.textContent.replace('[+]', '[-]');
    } else {
        // Update header text to show [+]
        header.textContent = header.textContent.replace('[-]', '[+]');
    }
}

function populateSearchableTerms() {
    const terms = [];
    const filterables = {
        'Type': { values: allTypes, filterType: 'types' },
        'Region': { values: allRegions, filterType: 'regions' },
        'Color': { values: getAllColors(), filterType: 'colors' },
        'Shape': { values: getAllShapes(), filterType: 'shapes' },
        'Egg Group': { values: getAllEggGroups(), filterType: 'eggGroups' },
        'Ability': { values: getAllAbilities(), filterType: 'abilities' }
    };

    for (const [typeLabel, data] of Object.entries(filterables)) {
        data.values.forEach(value => {
            const displayValue = value.charAt(0).toUpperCase() + value.slice(1);
            terms.push({ 
                label: `${typeLabel}: ${displayValue}`, 
                filterType: data.filterType, 
                filterValue: value 
            });
        });
    }
    
    getAllSpeciesSearchTerms().forEach(term => {
        terms.push({
            label: `Species: ${term}`, 
            filterType: 'secondary-species',
            filterValue: term 
        });
    });

    if (learnsetLoaded) {
        const allMoves = getAllMoves();
        allMoves.forEach(move => {
            const displayName = formatMoveName(move);
            
            terms.push({
                label: `Move: ${displayName}`,
                filterType: 'moves',
                filterValue: move
            });
        });
    }

    const nameMap = new Map(); 

    Object.keys(pokemonData).forEach(key => {
        const pokemon = pokemonData[key];
        
        let displayFullName = pokemon.name.trim(); 
        
        if (pokemon.baseSpecies && pokemon.forme) {
            const baseName = pokemon.baseSpecies.charAt(0).toUpperCase() + pokemon.baseSpecies.slice(1);
            const formeName = pokemon.forme.charAt(0).toUpperCase() + pokemon.forme.slice(1);
            displayFullName = `${formeName} ${baseName}`; 
        } else {
             displayFullName = displayFullName.charAt(0).toUpperCase() + displayFullName.slice(1);
        }

        if (!nameMap.has(displayFullName)) {
            nameMap.set(displayFullName, true);
            
            terms.push({
                label: `Name: ${displayFullName}`,
                filterType: 'secondary-name',
                filterValue: getGroupingKey(pokemon.name), 
                displayName: displayFullName, 
                pokemonKey: key 
            });
        }
        
        if (Math.floor(pokemon.num) === pokemon.num) {
            terms.push({
                label: `Num: ${pokemon.num} (${displayFullName})`, 
                filterType: 'secondary-num',
                filterValue: pokemon.num.toString(),
                displayName: displayFullName, 
                pokemonKey: key 
            });
        }
    });

    searchableTerms = terms;
}

function handleSearchInput() {
    const input = document.getElementById('searchBar');
    const suggestionsList = document.getElementById('suggestions');
    const query = input.value.toLowerCase().trim();
    suggestionsList.innerHTML = '';
    
    if (query.length < 2) return;

    const matchedTerms = searchableTerms.filter(term => {
        return term.label.toLowerCase().includes(query);
    }).slice(0, 10); 

    matchedTerms.forEach(term => {
        const li = document.createElement('li');
        li.textContent = term.label;
        li.addEventListener('click', () => {
            if (term.filterType.startsWith('secondary')) {
                secondaryFilter.type = term.filterType;
                secondaryFilter.value = term.filterValue;
                secondaryFilter.displayValue = term.displayName || term.filterValue; 
                secondaryFilter.selectedKey = term.pokemonKey; 

                input.value = secondaryFilter.displayValue; 
                
                renderPokemonList();
                updateActiveFilters();
                updateSortButtons();
            } else {
                toggleFilter(term.filterType, term.filterValue);
            }
            suggestionsList.innerHTML = '';
        });
        suggestionsList.appendChild(li);
    });
}

function renderPokemonList() {
  const container = document.getElementById('pokemonContainer');
  container.innerHTML = '';
  
  let pokemonToDisplay = Object.values(pokemonData);
  
  if (secondaryFilter.type === 'secondary-name' || secondaryFilter.type === 'secondary-num') {
      const selectedKey = secondaryFilter.selectedKey;
      if (selectedKey) {
          const chainKeys = findFullEvolutionChainKeys(selectedKey);
          
          pokemonToDisplay = chainKeys.map(key => pokemonData[key]).filter(p => p);
          
          pokemonToDisplay.sort((a, b) => {
              const keyA = getPokemonKey(a);
              const keyB = getPokemonKey(b);
              
              if (keyA === selectedKey) return -1;
              if (keyB === selectedKey) return 1;
              
              return a.num - b.num;
          });

      } else {
          pokemonToDisplay = [];
      }
  } else if (secondaryFilter.type === 'secondary-species') {
       const searchTerm = secondaryFilter.value.toLowerCase();
       pokemonToDisplay = pokemonToDisplay.filter(pokemon => 
          (pokemon.species || '').toLowerCase().includes(searchTerm)
      );
  }

  if (!secondaryFilter.type || secondaryFilter.type === 'secondary-species') {
      if (activeFilters.types.length > 0) {
        pokemonToDisplay = pokemonToDisplay.filter(pokemon => 
          activeFilters.types.every(type => pokemon.types.includes(type))
        );
      }
      if (activeFilters.regions.length > 0) {
        pokemonToDisplay = pokemonToDisplay.filter(pokemon => 
          activeFilters.regions.includes(pokemon.region)
        );
      }
      if (activeFilters.abilities.length > 0) {
        pokemonToDisplay = pokemonToDisplay.filter(pokemon => {
          const pokemonAbilities = extractAbilities(pokemon.abilities);
          return activeFilters.abilities.every(ability => pokemonAbilities.includes(ability));
        });
      }
      if (activeFilters.colors.length > 0) {
        pokemonToDisplay = pokemonToDisplay.filter(pokemon => 
          activeFilters.colors.includes(pokemon.color)
        );
      }
      if (activeFilters.variantExclude.length > 0) {
        pokemonToDisplay = pokemonToDisplay.filter(pokemon => 
          !pokemon.variant || !activeFilters.variantExclude.includes(pokemon.variant)
        );
      }
      if (activeFilters.shapes.length > 0) {
        pokemonToDisplay = pokemonToDisplay.filter(pokemon => {
          const shapeName = typeof pokemon.shape === 'number' ? getShapeName(pokemon.shape) : pokemon.shape;
          return activeFilters.shapes.includes(shapeName);
        });
      }
      if (activeFilters.eggGroups.length > 0) {
        pokemonToDisplay = pokemonToDisplay.filter(pokemon => {
          return pokemon.eggGroups && activeFilters.eggGroups.every(group => pokemon.eggGroups.includes(group));
        });
      }
      
      if (activeFilters.moves.length > 0 && learnsetLoaded) {
        pokemonToDisplay = pokemonToDisplay.filter(pokemon => {
            if (!pokemon.learnset) return false;

            return activeFilters.moves.every(move => {
                if (!pokemon.learnset[move]) return false;

                const learnMethods = pokemon.learnset[move];

                return learnMethods.some(method => {
                    const methodType = method[0];

                    if (methodType === 'L' || methodType === 'E' || methodType === 'S') return true;
                    if (methodType === 'M') return showTMMoves;
                    if (methodType === 'T') return showTutorMoves;
                    if (methodType === 'V') return showVCMoves;

                    return true;
                });
            });
        });
      }
      
      if (!secondaryFilter.type) {
         pokemonToDisplay = sortList(pokemonToDisplay, currentSort.key, currentSort.direction);
      }
  }

  if (pokemonToDisplay.length === 0) {
    container.innerHTML = '<div class="no-results">No Pokémon match your filters</div>';
    return;
  }
  
  pokemonToDisplay.forEach(pokemon => {
    const card = document.createElement('div');
    card.className = 'pokemon-card';
    const shapeName = typeof pokemon.shape === 'number' ? getShapeName(pokemon.shape) : pokemon.shape;
    
    const quickClearButton = secondaryFilter.type ? `<span class="quick-clear" onclick="clearSecondaryFilter()">[X]</span>` : '';

    let titleContent = '';
    const isForm = pokemon.baseSpecies || Math.floor(pokemon.num) !== pokemon.num;

    if (isForm) {
        const baseName = (pokemon.baseSpecies || pokemon.name).trim();
        let baseNameCapitalized = baseName.charAt(0).toUpperCase() + baseName.slice(1);
        
        let formeName = (pokemon.forme || (pokemon.name.includes('-') ? pokemon.name.split('-').slice(1).join('-') : '')).trim();
        let formeNameCapitalized = formeName.charAt(0).toUpperCase() + formeName.slice(1);
        
        if (pokemon.baseSpecies) {
            if (formeNameCapitalized === 'Galar') formeNameCapitalized = 'Galarian';
            else if (formeNameCapitalized === 'Alola') formeNameCapitalized = 'Alolan';
            else if (formeNameCapitalized === 'Hisui') formeNameCapitalized = 'Hisuian';
            else if (formeNameCapitalized === 'Paldea') formeNameCapitalized = 'Paldean';
            
            if (displaySettings.showName) {
                titleContent = `${formeNameCapitalized} ${baseNameCapitalized}`;
            }
        } else {
            if (displaySettings.showName) {
                titleContent = pokemon.name.trim().split('-').map(p => p.charAt(0).toUpperCase() + p.slice(1)).join('-');
            }
        }
        
    } else {
        const nameTrimmed = pokemon.name.trim();
        const numDisplay = displaySettings.showNumber ? `# ${Math.floor(pokemon.num)} ` : '';
        
        if (displaySettings.showName) {
            const nameCapitalized = nameTrimmed.split('-').map(p => p.charAt(0).toUpperCase() + p.slice(1)).join('-');
            titleContent = `${numDisplay}${nameCapitalized}`;
        } else {
            titleContent = numDisplay;
        }
    }
    
    const speciesDisplay = displaySettings.showSpecies && pokemon.species ? 
        ` (Species: <span>${pokemon.species}</span>)` : '';

    const pokemonKey = getPokemonKey(pokemon);
    const hasMovesFilter = activeFilters.moves.length > 0;
    const isExpanded = pokemonMovesExpanded[pokemonKey];
    
    // Determine what to show for moves
    let movesContent = '';
    let showMovesToggle = false;
    
    if (learnsetLoaded && pokemon.learnset) {
        if (hasMovesFilter) {
            // Show filtered moves
            const filteredMovesHTML = getMovesHTML(pokemon.learnset, pokemonKey, true);
            if (filteredMovesHTML) {
                movesContent = 'Moves: ' + filteredMovesHTML;
                showMovesToggle = true;
            }
            
            // If expanded, also show all moves below
            if (isExpanded) {
                const allMovesHTML = getMovesHTML(pokemon.learnset, pokemonKey, false);
                if (allMovesHTML) {
                    movesContent += '<div style="margin-top: 2px; padding-top: 2px; border-top: 1px solid #ccc;">All: ' + allMovesHTML + '</div>';
                }
            }
        } else if (isExpanded) {
            // No filter, but expanded - show all moves
            const allMovesHTML = getMovesHTML(pokemon.learnset, pokemonKey, false);
            if (allMovesHTML) {
                movesContent = 'Moves: ' + allMovesHTML;
            }
        }
        
        // Show toggle button if there are moves to show and learnset loaded
        if (Object.keys(pokemon.learnset).length > 0) {
            showMovesToggle = true;
        }
    }
    
    const regionSelected = activeFilters.regions.includes(pokemon.region);
    const colorSelected = activeFilters.colors.includes(pokemon.color);
    const shapeSelected = activeFilters.shapes.includes(shapeName);
    
    const regionClass = regionSelected ? 'clickable selected-result' : 'clickable';
    const colorClass = colorSelected ? 'clickable selected-result' : 'clickable';
    const shapeClass = shapeSelected ? 'clickable selected-result' : 'clickable';
    
    // Build card details based on settings
    let cardDetailsHTML = '<div class="card-details">' + getTypesHTML(pokemon.types);
    
    if (displaySettings.region.display !== 'hide') {
      const regionPrefix = displaySettings.region.desc === 'full' ? 'Region: ' : 
                          displaySettings.region.desc === 'short' ? '⛴ ' : '';
      const regionStyle = displaySettings.region.display === 'color' ? 
        'style="background-color: #87CEEB; color: white; padding: 2px 4px;"' : '';
      
      if (cardDetailsHTML.trim().endsWith('</div>')) {
        cardDetailsHTML = cardDetailsHTML.replace('</div>', '');
      }
      if (getTypesHTML(pokemon.types)) cardDetailsHTML += ' | ';
      cardDetailsHTML += `${regionPrefix}<span class="${regionClass}" data-filter-type="regions" data-filter-value="${pokemon.region || ''}" ${regionStyle}>${pokemon.region || 'N/A'}</span>`;
    }
    
    if (displaySettings.color.display !== 'hide') {
      const colorPrefix = displaySettings.color.desc === 'full' ? 'Color: ' : 
                         displaySettings.color.desc === 'short' ? '⬔ ' : '';
      const colorStyle = displaySettings.color.display === 'color' ? 
        `style="background-color: ${pokemon.color || '#ccc'}; color: white; padding: 2px 4px;"` : '';
      
      if (displaySettings.region.display !== 'hide' || getTypesHTML(pokemon.types)) cardDetailsHTML += ' | ';
      cardDetailsHTML += `${colorPrefix}<span class="${colorClass}" data-filter-type="colors" data-filter-value="${pokemon.color || ''}" ${colorStyle}>${pokemon.color || 'N/A'}</span>`;
    }
    
    if (displaySettings.shape.display !== 'hide') {
      const shapePrefix = displaySettings.shape.desc === 'full' ? 'Shape: ' : 
                         displaySettings.shape.desc === 'short' ? '⭔ ' : '';
      const shapeStyle = displaySettings.shape.display === 'color' ? 
        'style="background-color: #DDA0DD; color: white; padding: 2px 4px;"' : '';
      
      if (displaySettings.region.display !== 'hide' || displaySettings.color.display !== 'hide' || getTypesHTML(pokemon.types)) {
        cardDetailsHTML += ' | ';
      }
      cardDetailsHTML += `${shapePrefix}<span class="${shapeClass}" data-filter-type="shapes" data-filter-value="${shapeName || ''}" ${shapeStyle}>${shapeName || 'N/A'}</span>`;
    }
    
    cardDetailsHTML += '</div>';
    
    const eggHTML = getEggGroupsHTML(pokemon.eggGroups);
    const eggSection = eggHTML ? `<div class="card-details">${eggHTML}</div>` : '';
    
    const abilitiesHTML = getAbilitiesHTML(pokemon.abilities);
    const abilitiesSection = abilitiesHTML ? `<div class="pokemon-abilities">${abilitiesHTML}</div>` : '';

    card.innerHTML = `
      <h3>${quickClearButton} ${titleContent}</h3>${speciesDisplay}
      ${showMovesToggle ? `<button onclick="togglePokemonMoves('${pokemonKey}')" style="margin-left: 4px; font-size: 9px;">${isExpanded ? '[-]' : '[+]'} Moves</button>` : ''}
      
      ${cardDetailsHTML}
      ${eggSection}
      ${abilitiesSection}
      
      <div class="pokemon-stats ${statsVisible ? '' : 'hidden'}">
          Stats: HP ${pokemon.baseStats.hp}/Atk ${pokemon.baseStats.atk}/Def ${pokemon.baseStats.def}/SpA ${pokemon.baseStats.spa}/SpD ${pokemon.baseStats.spd}/Spe ${pokemon.baseStats.spe}
      </div>
      
      ${movesContent ? `<div class="pokemon-moves">${movesContent}</div>` : ''}
    `;
    
    // Apply font size to card
    card.style.fontSize = displaySettings.baseFontSize + 'px';

    card.querySelectorAll('.clickable').forEach(element => {
      element.addEventListener('click', function(e) {
        e.stopPropagation();
        const filterType = this.getAttribute('data-filter-type');
        const filterValue = this.getAttribute('data-filter-value');
        if (filterType && filterValue && filterValue !== 'Unknown' && filterValue !== '' && filterValue !== 'N/A') {
          if (secondaryFilter.type) {
             clearSecondaryFilter();
          }
          toggleFilter(filterType, filterValue);
        }
      });
    });

    container.appendChild(card);
  });
}

function sortList(list, sortBy, direction) {
    list.sort((a, b) => {
        let valA, valB;

        if (sortBy === 'number') {
            valA = a.num;
            valB = b.num;
        } else if (sortBy === 'height') { 
            valA = a.heightm || 0;
            valB = b.heightm || 0;
        } else if (sortBy === 'color') {
            valA = a.color || '';
            valB = b.color || '';
            if (valA.localeCompare(valB) === 0) return (a.name || '').localeCompare(b.name || '') * direction;
        } else if (sortBy === 'shape') {
            valA = a.shape || 0;
            valB = b.shape || 0;
        } else if (sortBy === 'name') {
            valA = a.name || '';
            valB = b.name || '';
        } else if (sortBy === 'type') {
            valA = a.types[0] || '';
            valB = b.types[0] || '';
            if (valA.localeCompare(valB) === 0) return (a.name || '').localeCompare(b.name || '') * direction;
        } else if (sortBy === 'movelevel') {
            // Sort by the minimum level of any filtered move
            valA = 9999; // Default high value if no moves found
            valB = 9999;
            
            if (activeFilters.moves.length > 0 && a.learnset) {
                activeFilters.moves.forEach(move => {
                    if (a.learnset[move]) {
                        const methods = a.learnset[move];
                        methods.forEach(method => {
                            if (method[0] === 'L') {
                                const level = method.length > 1 ? parseInt(method.substring(1)) : 0;
                                valA = Math.min(valA, level);
                            } else if (method[0] === 'E' || method[0] === 'S') {
                                valA = Math.min(valA, 0); // Egg/Special moves are level 0
                            }
                        });
                    }
                });
            }
            
            if (activeFilters.moves.length > 0 && b.learnset) {
                activeFilters.moves.forEach(move => {
                    if (b.learnset[move]) {
                        const methods = b.learnset[move];
                        methods.forEach(method => {
                            if (method[0] === 'L') {
                                const level = method.length > 1 ? parseInt(method.substring(1)) : 0;
                                valB = Math.min(valB, level);
                            } else if (method[0] === 'E' || method[0] === 'S') {
                                valB = Math.min(valB, 0);
                            }
                        });
                    }
                });
            }
        }

        let comparison = 0;
        if (typeof valA === 'string') {
            comparison = valA.localeCompare(valB);
        } else {
            comparison = valA - valB;
        }
        
        return comparison * direction;
    });
    return list;
}

function handleSort(sortBy) {
    if (currentSort.key === sortBy) {
        currentSort.direction *= -1;
    } else {
        currentSort.key = sortBy;
        currentSort.direction = 1; 
    }
    renderPokemonList();
}

function updateSortButtons() {
    const sortButtons = document.querySelectorAll('.controls button');
    const sortHeader = document.getElementById('sortHeader');
    const isNameSelected = secondaryFilter.type === 'secondary-name' || secondaryFilter.type === 'secondary-num';
    
    sortButtons.forEach(button => {
        if (isNameSelected) {
            button.classList.add('disabled-sort');
        } else {
            button.classList.remove('disabled-sort');
        }
    });
    
    if (sortHeader) {
        if (isNameSelected) {
            sortHeader.classList.add('disabled-sort');
        } else {
            sortHeader.classList.remove('disabled-sort');
        }
    }
}

function populateFilterOptions() {
  const populate = (id, items, type, attr, htmlFunc) => {
    const container = document.getElementById(id);
    container.innerHTML = '';
    items.forEach(item => {
      const chip = document.createElement('div');
      chip.className = 'filter-chip';
      chip.setAttribute(attr, item);
      chip.innerHTML = htmlFunc ? htmlFunc(item) : item;
      chip.addEventListener('click', function(e) {
        e.stopPropagation();
        toggleFilter(type, item);
      });
      container.appendChild(chip);
    });
  };

  populate('typeFilters', allTypes, 'types', 'data-type');
  populate('regionFilters', allRegions, 'regions', 'data-region');
  populate('colorFilters', getAllColors(), 'colors', 'data-color');
  populate('variantExcludeFilters', getAllVariantTypes(), 'variantExclude', 'data-variant');
  populate('shapeFilters', getAllShapes(), 'shapes', 'data-shape');
  populate('eggGroupFilters', getAllEggGroups(), 'eggGroups', 'data-egggroup');
}

function loadLearnsetData() {
    if (learnsetLoaded) return;

    const loadingIndicator = document.createElement('div');
    loadingIndicator.id = 'loadingIndicator';
    loadingIndicator.className = 'loading-indicator';
    loadingIndicator.textContent = 'Loading move data...';
    document.body.appendChild(loadingIndicator);

    const script = document.createElement('script');
    script.src = 'moveset-data.js';
    script.onload = function () {
        if (typeof movesetData !== 'undefined') {
            Object.keys(movesetData).forEach(pokemonId => {
                if (pokemonData[pokemonId]) {
                    pokemonData[pokemonId].learnset = movesetData[pokemonId].learnset;
                }
            });

            learnsetLoaded = true;
            const loadButton = document.getElementById('loadMovesButton');
            if (loadButton) {
                loadButton.disabled = true;
                loadButton.textContent = 'Moves Loaded';
                loadButton.style.color = '#000';
                loadButton.style.borderColor = '#000';
                loadButton.style.backgroundColor = '#ddd';
            }

            document.body.removeChild(loadingIndicator);

            document.getElementById('movesFilterGroup').style.display = 'block';
            
            populateSearchableTerms();
            renderPokemonList();
        } else {
            console.error('Move data not found');
            if (document.body.contains(loadingIndicator)) {
                document.body.removeChild(loadingIndicator);
            }
        }
    };

    script.onerror = function () {
        console.error('Error loading move data');
        if (document.body.contains(loadingIndicator)) {
            document.body.removeChild(loadingIndicator);
        }
    };

    document.head.appendChild(script);
}

function populateMovesFilter() {
    // No longer needed - moves filter section removed
}

function openSettings() {
    document.getElementById('settingsModal').style.display = 'block';
    
    // Load current settings
    document.getElementById('baseFontSize').value = displaySettings.baseFontSize;
    document.getElementById('showNumber').value = displaySettings.showNumber.toString();
    document.getElementById('showName').value = displaySettings.showName.toString();
    document.getElementById('showSpecies').value = displaySettings.showSpecies.toString();
    document.getElementById('typesDesc').value = displaySettings.types.desc;
    document.getElementById('typesDisplay').value = displaySettings.types.display;
    document.getElementById('regionDesc').value = displaySettings.region.desc;
    document.getElementById('regionDisplay').value = displaySettings.region.display;
    document.getElementById('colorDesc').value = displaySettings.color.desc;
    document.getElementById('colorDisplay').value = displaySettings.color.display;
    document.getElementById('shapeDesc').value = displaySettings.shape.desc;
    document.getElementById('shapeDisplay').value = displaySettings.shape.display;
    document.getElementById('eggDesc').value = displaySettings.egg.desc;
    document.getElementById('eggDisplay').value = displaySettings.egg.display;
    document.getElementById('abilitiesDesc').value = displaySettings.abilities.desc;
    document.getElementById('abilitiesDisplay').value = displaySettings.abilities.display;
}

function closeSettings() {
    document.getElementById('settingsModal').style.display = 'none';
}

function applySettings() {
    displaySettings.baseFontSize = parseInt(document.getElementById('baseFontSize').value);
    displaySettings.showNumber = document.getElementById('showNumber').value === 'true';
    displaySettings.showName = document.getElementById('showName').value === 'true';
    displaySettings.showSpecies = document.getElementById('showSpecies').value === 'true';
    displaySettings.types.desc = document.getElementById('typesDesc').value;
    displaySettings.types.display = document.getElementById('typesDisplay').value;
    displaySettings.region.desc = document.getElementById('regionDesc').value;
    displaySettings.region.display = document.getElementById('regionDisplay').value;
    displaySettings.color.desc = document.getElementById('colorDesc').value;
    displaySettings.color.display = document.getElementById('colorDisplay').value;
    displaySettings.shape.desc = document.getElementById('shapeDesc').value;
    displaySettings.shape.display = document.getElementById('shapeDisplay').value;
    displaySettings.egg.desc = document.getElementById('eggDesc').value;
    displaySettings.egg.display = document.getElementById('eggDisplay').value;
    displaySettings.abilities.desc = document.getElementById('abilitiesDesc').value;
    displaySettings.abilities.display = document.getElementById('abilitiesDisplay').value;
    
    renderPokemonList();
    closeSettings();
}

document.addEventListener('DOMContentLoaded', () => {
  initializeNameKeyMap(); 
  assignRegions(pokemonData); 
  populateFilterOptions();
  populateSearchableTerms();
  renderPokemonList();
  updateActiveFilters();
  updateSortButtons();

  document.getElementById('filterToggleHeader').addEventListener('click', toggleFilterContainer);

  document.getElementById('searchBar').addEventListener('input', handleSearchInput);
  document.getElementById('searchBar').addEventListener('focus', handleSearchInput); 
  document.getElementById('searchBar').addEventListener('blur', () => {
    setTimeout(() => {
        document.getElementById('suggestions').innerHTML = '';
    }, 200);
  });
  
  // Settings icon click and long press
  const settingsIcon = document.getElementById('settingsIcon');
  
  settingsIcon.addEventListener('click', () => {
    openSettings();
  });
  
  settingsIcon.addEventListener('touchstart', (e) => {
    settingsPressTimer = setTimeout(() => {
      openSettings();
    }, 500);
  });
  
  settingsIcon.addEventListener('touchend', () => {
    clearTimeout(settingsPressTimer);
  });
  
  settingsIcon.addEventListener('mousedown', (e) => {
    if (e.button === 0) {
      settingsPressTimer = setTimeout(() => {
        openSettings();
      }, 500);
    }
  });
  
  settingsIcon.addEventListener('mouseup', () => {
    clearTimeout(settingsPressTimer);
  });
  
  document.getElementById('closeSettings').addEventListener('click', closeSettings);
  
  // Close modal when clicking outside
  document.getElementById('settingsModal').addEventListener('click', (e) => {
    if (e.target.id === 'settingsModal') {
      closeSettings();
    }
  });
});

let tapTimer = null;
let lastTapTime = 0;

document.addEventListener("touchend", (e) => {
    const currentTime = new Date().getTime();
    const tapLength = currentTime - lastTapTime;
    
    if (tapLength < 300 && tapLength > 0) {
        // Double tap detected
        e.preventDefault();
        window.scrollTo({ top: 0, behavior: "smooth" });
        lastTapTime = 0;
    } else {
        lastTapTime = currentTime;
    }
});


  </script></div>
<p id="copyright">©2025 daviddot.com. Pokémon ©1995 Nintendo. For informational use only.</p>
</div></body>
</html>