<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>FHE FIGHTER II</title>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <style>
    @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
    
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Press Start 2P', cursive;
        background: #000;
        color: #fff;
        overflow-x: hidden;
        image-rendering: pixelated;
        user-select: none;
    }

    .crt-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        background: repeating-linear-gradient(
            0deg,
            rgba(0, 0, 0, 0.15),
            rgba(0, 0, 0, 0.15) 1px,
            transparent 1px,
            transparent 2px
        );
        z-index: 1000;
    }

    .game-container {
        width: 100%;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        position: relative;
    }

    .header {
        background: linear-gradient(180deg, #1a4d8f 0%, #0d2847 100%);
        border: 4px solid #ffd700;
        padding: 15px;
        margin-bottom: 20px;
        box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
    }

    .title {
        font-size: 24px;
        text-align: center;
        color: #ffd700;
        text-shadow: 3px 3px 0 #ff0000, 6px 6px 0 #000;
        margin-bottom: 10px;
        animation: glow 2s ease-in-out infinite;
    }

    @keyframes glow {
        0%, 100% { text-shadow: 3px 3px 0 #ff0000, 6px 6px 0 #000, 0 0 10px #ffd700; }
        50% { text-shadow: 3px 3px 0 #ff0000, 6px 6px 0 #000, 0 0 30px #ffd700; }
    }

    .stats-bar {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        font-size: 10px;
        margin-top: 10px;
    }

    .stat-item {
        background: rgba(0, 0, 0, 0.7);
        padding: 8px;
        border: 2px solid #00ff00;
    }

    .timer-display {
        font-size: 32px;
        color: #00ff00;
        text-align: center;
        margin: 10px 0;
        text-shadow: 0 0 10px #00ff00;
    }

    .timer-display.warning {
        color: #ffff00;
        animation: pulse 0.5s infinite;
    }

    .timer-display.danger {
        color: #ff0000;
        animation: pulse 0.3s infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    .score-display {
        font-size: 28px;
        color: #ffd700;
        text-align: center;
        text-shadow: 2px 2px 0 #ff0000;
    }

    .multipliers {
        display: flex;
        justify-content: center;
        gap: 10px;
        flex-wrap: wrap;
        min-height: 40px;
        margin-top: 10px;
    }

    .multiplier {
        background: #ff00ff;
        color: #fff;
        padding: 5px 10px;
        border: 2px solid #fff;
        font-size: 8px;
        animation: bounce 0.5s;
        box-shadow: 0 0 10px #ff00ff;
    }

    @keyframes bounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-10px); }
    }

    .arena {
        background: linear-gradient(180deg, #2a5298 0%, #1e3a5f 50%, #8b4513 100%);
        border: 6px solid #8b4513;
        padding: 30px 20px;
        min-height: 400px;
        position: relative;
        margin-bottom: 20px;
        box-shadow: inset 0 0 50px rgba(0, 0, 0, 0.5);
    }

    .choices {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        margin-top: 20px;
    }

    .choice-card {
        background: linear-gradient(180deg, #4a90e2 0%, #2563eb 100%);
        border: 4px solid #ffd700;
        padding: 20px 10px;
        text-align: center;
        cursor: pointer;
        position: relative;
        transition: transform 0.1s;
        font-size: 11px;
        line-height: 1.6;
        min-height: 120px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 0 #996600, 0 8px 20px rgba(0, 0, 0, 0.5);
    }

    .choice-card:hover {
        transform: translateY(-5px) scale(1.05);
        box-shadow: 0 6px 0 #996600, 0 12px 30px rgba(255, 215, 0, 0.6);
    }

    .choice-card:active {
        transform: translateY(2px);
        box-shadow: 0 2px 0 #996600;
    }

    .explosion {
        position: absolute;
        font-size: 60px;
        animation: explode 0.6s forwards;
        pointer-events: none;
    }

    @keyframes explode {
        0% { transform: scale(0) rotate(0deg); opacity: 1; }
        50% { transform: scale(1.5) rotate(180deg); opacity: 1; }
        100% { transform: scale(2) rotate(360deg); opacity: 0; }
    }

    .instruction {
        text-align: center;
        font-size: 14px;
        color: #ffff00;
        margin-bottom: 20px;
        text-shadow: 2px 2px 0 #000;
        animation: blink 1.5s infinite;
    }

    @keyframes blink {
        0%, 49% { opacity: 1; }
        50%, 100% { opacity: 0.3; }
    }

    .results-screen {
        background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
        border: 6px solid #ffd700;
        padding: 30px;
        text-align: center;
        display: none;
    }

    .results-screen.active {
        display: block;
    }

    .final-score {
        font-size: 48px;
        color: #ffd700;
        margin: 20px 0;
        text-shadow: 3px 3px 0 #ff0000;
    }

    .top-picks {
        background: rgba(0, 0, 0, 0.5);
        border: 3px solid #00ff00;
        padding: 20px;
        margin: 20px 0;
        text-align: left;
    }

    .top-picks h3 {
        color: #00ff00;
        font-size: 16px;
        margin-bottom: 15px;
        text-align: center;
    }

    .top-picks ol {
        list-style: none;
        counter-reset: item;
    }

    .top-picks li {
        counter-increment: item;
        padding: 10px;
        margin: 8px 0;
        background: rgba(255, 255, 255, 0.1);
        border-left: 4px solid #ffd700;
        font-size: 11px;
    }

    .top-picks li:before {
        content: counter(item) ". ";
        color: #ffd700;
        font-weight: bold;
        margin-right: 10px;
    }

    .high-scores {
        background: rgba(0, 0, 0, 0.7);
        border: 3px solid #ff00ff;
        padding: 20px;
        margin: 20px 0;
    }

    .high-scores h3 {
        color: #ff00ff;
        font-size: 14px;
        margin-bottom: 15px;
    }

    .high-score-entry {
        display: flex;
        justify-content: space-between;
        padding: 8px;
        margin: 5px 0;
        border-bottom: 1px solid #444;
        font-size: 10px;
    }

    .arcade-button {
        background: linear-gradient(180deg, #ff0000 0%, #cc0000 100%);
        color: #fff;
        border: 4px solid #fff;
        padding: 15px 30px;
        font-family: 'Press Start 2P', cursive;
        font-size: 12px;
        cursor: pointer;
        margin: 10px;
        box-shadow: 0 6px 0 #800000, 0 8px 20px rgba(0, 0, 0, 0.5);
        transition: transform 0.1s;
    }

    .arcade-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 0 #800000, 0 10px 25px rgba(255, 0, 0, 0.5);
    }

    .arcade-button:active {
        transform: translateY(3px);
        box-shadow: 0 3px 0 #800000;
    }

    .arcade-button.secondary {
        background: linear-gradient(180deg, #4a90e2 0%, #2563eb 100%);
        box-shadow: 0 6px 0 #1e40af, 0 8px 20px rgba(0, 0, 0, 0.5);
    }

    .arcade-button.secondary:hover {
        box-shadow: 0 8px 0 #1e40af, 0 10px 25px rgba(37, 99, 235, 0.5);
    }

    .arcade-button.secondary:active {
        box-shadow: 0 3px 0 #1e40af;
    }

    .progress-text {
        text-align: center;
        font-size: 12px;
        color: #ffff00;
        margin-top: 10px;
    }

    .name-input-screen {
        background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
        border: 6px solid #ffd700;
        padding: 40px;
        text-align: center;
        margin-top: 50px;
    }

    .name-input-screen h2 {
        font-size: 18px;
        color: #ffd700;
        margin-bottom: 30px;
    }

    .name-input-screen input {
        background: rgba(0, 0, 0, 0.7);
        border: 3px solid #00ff00;
        color: #00ff00;
        font-family: 'Press Start 2P', cursive;
        font-size: 14px;
        padding: 15px;
        width: 100%;
        max-width: 300px;
        text-align: center;
        margin-bottom: 20px;
    }

    .screenshot-area {
        background: linear-gradient(180deg, #1a4d8f 0%, #0d2847 100%);
        border: 6px solid #ffd700;
        padding: 30px;
        margin: 20px auto;
        max-width: 600px;
    }

    @media (max-width: 600px) {
        .title { font-size: 16px; }
        .choices { grid-template-columns: 1fr; }
        .choice-card { font-size: 10px; min-height: 100px; }
        .stats-bar { grid-template-columns: 1fr; }
        .timer-display { font-size: 24px; }
        .score-display { font-size: 20px; }
    }
    </style>
</head>
<body>
    <div class="crt-overlay"></div>
    <div class="game-container" id="gameContainer">
        
        <!-- Name Input Screen -->
        <div class="name-input-screen" id="nameInputScreen">
            <h2>ENTER YOUR NAME</h2>
            <input type="text" id="playerName" maxlength="10" placeholder="PLAYER1" />
            <div>
                <button class="arcade-button" onclick="startGame()">START GAME</button>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="gameScreen" style="display: none;">
            <div class="header">
                <div class="title">FHE FIGHTER II</div>
                <div class="timer-display" id="timer">15.00</div>
                <div class="score-display" id="score">SCORE: 0</div>
                <div class="multipliers" id="multipliers"></div>
                <div class="stats-bar">
                    <div class="stat-item">REMAINING: <span id="remainingCount">30</span></div>
                    <div class="stat-item">FAVORITES: <span id="favsCount">0</span></div>
                </div>
            </div>

            <div class="arena">
                <div class="instruction">TAP TO CHOOSE YOUR FAVORITE!</div>
                <div class="choices" id="choices"></div>
                <div class="progress-text" id="progressText"></div>
            </div>
        </div>

        <!-- Results Screen -->
        <div class="results-screen" id="resultsScreen">
            <div class="screenshot-area" id="screenshotArea">
                <div class="title">GAME OVER</div>
                <div class="final-score" id="finalScore">0</div>
                <div style="font-size: 14px; color: #ffd700; margin: 10px 0;" id="playerNameDisplay"></div>
                
                <div class="top-picks">
                    <h3>YOUR TOP 5 ACTIVITIES</h3>
                    <ol id="topPicksList"></ol>
                </div>
            </div>

            <div class="high-scores">
                <h3>HIGH SCORES</h3>
                <div id="highScoresList"></div>
            </div>

            <div>
                <button class="arcade-button secondary" onclick="shareScore()">SHARE SCORE</button>
                <button class="arcade-button" onclick="resetGame()">PLAY AGAIN</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
    const GOOGLE_SHEET_URL = 'https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec';
    
    const ACTIVITIES = [
        "Board Games", "Nature Walk", "Nerf Guns", "Family Feud", "Charades", 
        "Nursing Home", "Small Group Dinners", "Local Band", "Frisbee Golf", 
        "Capture The Flag", "Thrift Swap", "Cookie Decorating", "Four Square", 
        "Volleyball", "Poetry Slam", "Pancakes", "AI Workshop", "Career Panel", 
        "Meal Delivery", "Dodgeball", "Mental Health", "Karaoke Night", 
        "City Council Meeting", "Burn Stuff", "Sardines", "PowerPoint Night",
        "Pickleball", "Arts & Crafts", "Chair Soccer", "Video Games"
    ];

    const FAKE_HIGH_SCORES = [
        { name: "RYU", score: 8750 },
        { name: "D&C", score: 8200 },
        { name: "SAM", score: 7890 },
        { name: "KEN", score: 7450 },
        { name: "JST", score: 7100 },
        { name: "1820", score: 6800 },
        { name: "YSA", score: 6550 },
        { name: "AMY", score: 6200 }
    ];

    let gameState = {
        playerName: '',
        score: 0,
        current: [],           // Items waiting to be shown this round
        evaluating: [],        // Current batch being evaluated
        survived: [],          // Items that survived this round so far
        eliminated: {},        // Items eliminated: {id: {eliminatedBy: [ids]}}
        favorites: [],         // Final top 5 list
        timer: 15,
        timerInterval: null,
        highScores: [...FAKE_HIGH_SCORES]
    };

    const BATCH_SIZE = 3;

    function shuffle(array) {
        const arr = [...array];
        for (let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
    }

    function getAvailableItems() {
        return ACTIVITIES.filter(id => 
            !gameState.favorites.includes(id) && 
            !gameState.eliminated[id]
        );
    }

    function startGame() {
        const nameInput = document.getElementById('playerName').value.trim() || 'PLAYER1';
        gameState.playerName = nameInput.toUpperCase().slice(0, 10);
        
        document.getElementById('nameInputScreen').style.display = 'none';
        document.getElementById('gameScreen').style.display = 'block';
        
        startNewRound();
    }

    function startNewRound() {
        const available = getAvailableItems();
        
        if (available.length === 0) {
            // All done!
            endGame();
            return;
        }
        
        if (available.length === 1) {
            // Last item automatically becomes a favorite
            addFavorite(available[0]);
            return;
        }
        
        gameState.current = shuffle(available);
        gameState.evaluating = [];
        gameState.survived = [];
        
        loadNextBatch();
    }

    function loadNextBatch() {
        if (gameState.current.length === 0) {
            // Round complete - prepare next round with survivors
            finalizeRound();
            return;
        }
        
        const batchSize = Math.min(BATCH_SIZE, gameState.current.length);
        gameState.evaluating = gameState.current.splice(0, batchSize);
        gameState.timer = 15;
        
        renderBatch();
        startTimer();
        updateUI();
    }

    function finalizeRound() {
        if (gameState.survived.length === 1) {
            // Single survivor becomes next favorite
            addFavorite(gameState.survived[0]);
            return;
        }
        
        if (gameState.survived.length === 0) {
            // Shouldn't happen, but just in case
            endGame();
            return;
        }
        
        // Start new round with survivors
        gameState.current = shuffle(gameState.survived);
        gameState.survived = [];
        loadNextBatch();
    }

    function addFavorite(itemId) {
        if (gameState.favorites.includes(itemId)) return;
        
        gameState.favorites.push(itemId);
        delete gameState.eliminated[itemId];
        
        // Rescue items that were only eliminated by this favorite
        rescueEligibleItems();
        
        if (gameState.favorites.length >= 5) {
            endGame();
            return;
        }
        
        // Continue with next round
        startNewRound();
    }

    function rescueEligibleItems() {
        const toRescue = [];
        
        Object.keys(gameState.eliminated).forEach(id => {
            const eliminatedBy = gameState.eliminated[id].eliminatedBy || [];
            if (eliminatedBy.length === 0) return;
            
            // If all eliminators are now favorites, rescue this item
            const allAreFavorites = eliminatedBy.every(e => gameState.favorites.includes(e));
            if (allAreFavorites) {
                toRescue.push(id);
            }
        });
        
        toRescue.forEach(id => delete gameState.eliminated[id]);
    }

    function renderBatch() {
        const choicesEl = document.getElementById('choices');
        choicesEl.innerHTML = '';
        
        gameState.evaluating.forEach(activity => {
            const card = document.createElement('div');
            card.className = 'choice-card';
            card.textContent = activity;
            card.onclick = () => selectActivity(activity, card);
            choicesEl.appendChild(card);
        });
    }

    function selectActivity(activity, element) {
        stopTimer();
        
        // Calculate score
        const timeBonus = Math.floor(gameState.timer * 10);
        let points = 100 + timeBonus;
        const multipliers = [];

        // Combo (time > 10)
        if (gameState.timer > 10) {
            points += 250;
            multipliers.push('COMBO!');
        }

        // Critical hit (ends in 0 or 5)
        const timeStr = gameState.timer.toFixed(2);
        const lastDigit = timeStr[timeStr.length - 1];
        if (lastDigit === '0' || lastDigit === '5') {
            points += 500;
            multipliers.push('CRITICAL!');
        }

        // 6-7 bonus
        if (timeStr.includes('6') && timeStr.includes('7')) {
            points += 777;
            multipliers.push('6-7 BONUS!');
        }

        // Random bonuses
        if (Math.random() > 0.7) {
            points += Math.floor(Math.random() * 300);
            multipliers.push('LUCKY!');
        }

        gameState.score += points;
        
        // Winner survives
        gameState.survived.push(activity);
        
        // Losers are eliminated
        const losers = gameState.evaluating.filter(a => a !== activity);
        losers.forEach(loser => {
            if (!gameState.eliminated[loser]) {
                gameState.eliminated[loser] = { eliminatedBy: [] };
            }
            if (!gameState.eliminated[loser].eliminatedBy.includes(activity)) {
                gameState.eliminated[loser].eliminatedBy.push(activity);
            }
        });

        // Clear evaluating
        gameState.evaluating = [];

        // Show effects
        showMultipliers(multipliers);
        createExplosion(element);
        
        setTimeout(() => {
            loadNextBatch();
        }, 1500);
    }

    function createExplosion(element) {
        const explosions = ['ðŸ’¥', 'âš¡', 'ðŸŒŸ', 'ðŸ’«', 'âœ¨'];
        const rect = element.getBoundingClientRect();
        
        for (let i = 0; i < 5; i++) {
            const explosion = document.createElement('div');
            explosion.className = 'explosion';
            explosion.textContent = explosions[Math.floor(Math.random() * explosions.length)];
            explosion.style.left = (rect.left + Math.random() * rect.width) + 'px';
            explosion.style.top = (rect.top + Math.random() * rect.height) + 'px';
            document.body.appendChild(explosion);
            
            setTimeout(() => explosion.remove(), 600);
        }
        
        element.style.opacity = '0';
    }

    function showMultipliers(multipliers) {
        const multipliersEl = document.getElementById('multipliers');
        multipliersEl.innerHTML = '';
        
        multipliers.forEach((text, i) => {
            setTimeout(() => {
                const mult = document.createElement('div');
                mult.className = 'multiplier';
                mult.textContent = text;
                multipliersEl.appendChild(mult);
                
                setTimeout(() => mult.remove(), 2000);
            }, i * 200);
        });
    }

    function startTimer() {
        const timerEl = document.getElementById('timer');
        gameState.timerInterval = setInterval(() => {
            gameState.timer -= 0.01;
            
            if (gameState.timer <= 0) {
                gameState.timer = 0;
                stopTimer();
                // Auto-select random choice
                const randomActivity = gameState.evaluating[Math.floor(Math.random() * gameState.evaluating.length)];
                const cards = document.querySelectorAll('.choice-card');
                const randomCard = cards[Math.floor(Math.random() * cards.length)];
                selectActivity(randomActivity, randomCard);
            }
            
            timerEl.textContent = gameState.timer.toFixed(2);
            timerEl.className = 'timer-display';
            if (gameState.timer < 5) timerEl.className += ' danger';
            else if (gameState.timer < 10) timerEl.className += ' warning';
        }, 10);
    }

    function stopTimer() {
        if (gameState.timerInterval) {
            clearInterval(gameState.timerInterval);
            gameState.timerInterval = null;
        }
    }

    function updateUI() {
        const available = getAvailableItems();
        const remaining = available.length;
        
        document.getElementById('score').textContent = `SCORE: ${gameState.score}`;
        document.getElementById('remainingCount').textContent = remaining;
        document.getElementById('favsCount').textContent = gameState.favorites.length;
        
        if (remaining > 10) {
            document.getElementById('progressText').textContent = 
                `${remaining} ACTIVITIES REMAINING!`;
        } else if (remaining > 5) {
            document.getElementById('progressText').textContent = 
                `FINAL ${remaining}! GETTING CLOSE!`;
        } else {
            document.getElementById('progressText').textContent = 
                `ALMOST THERE! ${5 - gameState.favorites.length} MORE PICKS!`;
        }
    }

    function endGame() {
        stopTimer();
        document.getElementById('gameScreen').style.display = 'none';
        document.getElementById('resultsScreen').classList.add('active');
        
        document.getElementById('finalScore').textContent = gameState.score;
        document.getElementById('playerNameDisplay').textContent = gameState.playerName;
        
        // Show top picks
        const topPicksList = document.getElementById('topPicksList');
        topPicksList.innerHTML = '';
        gameState.favorites.forEach(pick => {
            const li = document.createElement('li');
            li.textContent = pick;
            topPicksList.appendChild(li);
        });
        
        // Update high scores
        gameState.highScores.push({ 
            name: gameState.playerName, 
            score: gameState.score 
        });
        gameState.highScores.sort((a, b) => b.score - a.score);
        gameState.highScores = gameState.highScores.slice(0, 8);
        
        // Display high scores
        const highScoresList = document.getElementById('highScoresList');
        highScoresList.innerHTML = '';
        gameState.highScores.forEach((entry, i) => {
            const div = document.createElement('div');
            div.className = 'high-score-entry';
            div.innerHTML = `<span>${i + 1}. ${entry.name}</span><span>${entry.score}</span>`;
            highScoresList.appendChild(div);
        });
        
        // Submit to Google Form
        submitToGoogleForm();
    }

    function submitToGoogleForm() {
        const formData = new FormData();
        formData.append('entry.name', gameState.playerName);
        formData.append('entry.score', gameState.score);
        formData.append('entry.picks', gameState.favorites.join(', '));
        
        fetch(GOOGLE_SHEET_URL, {
            method: 'POST',
            body: formData,
            mode: 'no-cors'
        }).catch(err => console.log('Form submission:', err));
    }

    async function shareScore() {
        const screenshotArea = document.getElementById('screenshotArea');
        
        try {
            const canvas = await html2canvas(screenshotArea, {
                backgroundColor: '#0d2847',
                scale: 2
            });
            
            canvas.toBlob(async (blob) => {
                const file = new File([blob], 'fhe-score.png', { type: 'image/png' });
                
                if (navigator.share && navigator.canShare({ files: [file] })) {
                    await navigator.share({
                        files: [file],
                        title: 'My FHE Fighter Score!',
                        text: `I scored ${gameState.score} points in FHE Fighter II!`
                    });
                } else {
                    // Fallback: download the image
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'fhe-fighter-score.png';
                    a.click();
                    URL.revokeObjectURL(url);
                    alert('Screenshot saved! Share it with your friends!');
                }
            });
        } catch (err) {
            console.error('Screenshot failed:', err);
            alert('Could not create screenshot. Try taking a screenshot manually!');
        }
    }

    function resetGame() {
        gameState = {
            playerName: '',
            score: 0,
            current: [],
            evaluating: [],
            survived: [],
            eliminated: {},
            favorites: [],
            timer: 15,
            timerInterval: null,
            highScores: gameState.highScores
        };
        
        document.getElementById('resultsScreen').classList.remove('active');
        document.getElementById('nameInputScreen').style.display = 'block';
        document.getElementById('playerName').value = '';
        document.getElementById('multipliers').innerHTML = '';
    }
    </script>
</body>
</html>
