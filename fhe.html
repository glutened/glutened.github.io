<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>FHE FIGHTER II</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
    
        body {
            font-family: 'Press Start 2P', cursive;
            background: #000;
            color: #fff;
            overflow-x: hidden;
            overflow-y: auto; 
            image-rendering: pixelated;
            user-select: none;
        }
    
        .crt-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 0, 0, 0.15),
                rgba(0, 0, 0, 0.15) 1px,
                transparent 1px,
                transparent 2px
            );
            z-index: 1000;
        }
    
        .game-container {
            width: 100%;
            margin: 0 auto;
            padding: 5px;
            position: relative;
        }
    
        .header {
            background: linear-gradient(180deg, #1a4d8f 0%, #0d2847 100%);
            border: 4px solid #ffd700;
            padding: 10px;
            margin-top: 20px;
            margin-bottom: 10px;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }
    
        .title {
            font-size: 20px;
            text-align: center;
            color: #ffd700;
            text-shadow: 2px 2px 0 #ff0000, 4px 4px 0 #000;
            margin-bottom: 5px;
            animation: glow 2s ease-in-out infinite;
        }
    
        @keyframes glow {
            0%, 100% { text-shadow: 2px 2px 0 #ff0000, 4px 4px 0 #000, 0 0 8px #ffd700; }
            50% { text-shadow: 2px 2px 0 #ff0000, 4px 4px 0 #000, 0 0 20px #ffd700; }
        }
    
        .health-bars {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }
    
        .health-bar-container {
            position: relative;
        }
    
        .health-label {
            font-size: 10px;
            color: #ffd700;
            margin-bottom: 3px;
            text-shadow: 1px 1px 0 #000;
        }
    
        .health-bar-outer {
            background: #000;
            border: 3px solid #fff;
            height: 25px;
            position: relative;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.5);
        }
    
        .health-bar-inner {
            background: linear-gradient(180deg, #00ff00 0%, #00cc00 50%, #009900 100%);
            height: 100%;
            transition: width 0.3s ease-out;
            position: relative;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
        }
    
        .health-bar-inner.low {
            background: linear-gradient(180deg, #ffff00 0%, #ffcc00 50%, #ff9900 100%);
            box-shadow: 0 0 10px rgba(255, 255, 0, 0.5);
        }
    
        .health-bar-inner.critical {
            background: linear-gradient(180deg, #ff0000 0%, #cc0000 50%, #990000 100%);
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
            animation: health-pulse 0.5s infinite;
        }
    
        @keyframes health-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
    
        .health-bar-segments {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
        }
    
        .health-segment {
            flex: 1;
            border-right: 2px solid rgba(0, 0, 0, 0.3);
        }
    
        .health-segment:last-child {
            border-right: none;
        }
    
        .health-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 10px;
            color: #fff;
            text-shadow: 1px 1px 2px #000;
            font-weight: bold;
            pointer-events: none;
        }
    
        .timer-display {
            font-size: 24px;
            color: #00ff00;
            text-align: center;
            margin: 5px 0;
            text-shadow: 0 0 8px #00ff00;
        }
    
        .timer-display.warning {
            color: #ffff00;
            animation: pulse 0.5s infinite;
        }
    
        .timer-display.danger {
            color: #ff0000;
            animation: pulse 0.3s infinite;
        }
    
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    
        .score-display {
            font-size: 20px;
            color: #ffd700;
            text-align: center;
            text-shadow: 2px 2px 0 #ff0000;
        }
    
        .multipliers {
            display: flex;
            justify-content: center;
            gap: 5px;
            flex-wrap: wrap;
            min-height: 20px;
            margin-top: 5px;
        }
    
        .multiplier {
            background: #ff00ff;
            color: #fff;
            padding: 5px 10px;
            border: 2px solid #fff;
            font-size: 10px;
            animation: bounce 0.5s;
            box-shadow: 0 0 8px #ff00ff;
        }
    
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
    
        .arena {
            background: linear-gradient(180deg, #2a5298 0%, #1e3a5f 50%, #8b4513 100%);
            border: 4px solid #8b4513;
            padding: 10px;
            min-height: 250px;
            position: relative;
            margin-bottom: 10px;
            box-shadow: inset 0 0 30px rgba(0, 0, 0, 0.5);
        }
    
        .choices {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 10px;
        }
    
        .choice-card {
            background: linear-gradient(180deg, #4a90e2 0%, #2563eb 100%);
            border: 3px solid #ffd700;
            padding: 10px 5px;
            text-align: center;
            cursor: pointer;
            position: relative;
            transition: transform 0.1s, opacity 0.3s ease-in-out;
            font-size: 12px;
            line-height: 1.4;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 0 #996600, 0 6px 10px rgba(0, 0, 0, 0.5);
        }
    
        .choice-card:hover {
            transform: translateY(-3px) scale(1.03);
            box-shadow: 0 4px 0 #996600, 0 8px 15px rgba(255, 215, 0, 0.6);
        }
    
        .choice-card:active {
            transform: translateY(1px);
            box-shadow: 0 1px 0 #996600;
        }
    
        .floating-score {
            position: fixed;
            color: #fff;
            text-shadow: 2px 2px 0 #ff00ff;
            font-size: 16px;
            font-weight: bold;
            pointer-events: none;
            animation: float-up-fade 1s forwards;
            z-index: 1001;
        }
    
        @keyframes float-up-fade {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-50px); opacity: 0; }
        }
    
        .explosion {
            position: absolute;
            font-size: 40px;
            animation: explode 0.6s forwards;
            pointer-events: none;
        }
    
        @keyframes explode {
            0% { transform: scale(0) rotate(0deg); opacity: 1; }
            50% { transform: scale(1) rotate(180deg); opacity: 1; }
            100% { transform: scale(1.5) rotate(360deg); opacity: 0; }
        }
    
        .instruction {
            text-align: center;
            font-size: 10px;
            color: #ffff00;
            margin-bottom: 10px;
            text-shadow: 1px 1px 0 #000;
            animation: blink 1.5s infinite;
        }
    
        @keyframes blink {
            0%, 49% { opacity: 1; }
            50%, 100% { opacity: 0.3; }
        }
    
        .results-screen {
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            border: 4px solid #ffd700;
            padding: 20px;
            text-align: center;
            display: none;
        }
    
        .results-screen.active {
            display: block;
        }
    
        .final-score {
            font-size: 32px;
            color: #ffd700;
            margin: 10px 0;
            text-shadow: 2px 2px 0 #ff0000;
        }
    
        .top-picks {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #00ff00;
            padding: 10px;
            margin: 10px 0;
            text-align: left;
        }
    
        .top-picks h3 {
            color: #00ff00;
            font-size: 12px;
            margin-bottom: 10px;
            text-align: center;
        }
    
        .top-picks ol {
            list-style: none;
            counter-reset: item;
        }
    
        .top-picks li {
            counter-increment: item;
            padding: 5px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.1);
            border-left: 3px solid #ffd700;
            font-size: 9px;
        }
    
        .top-picks li:before {
            content: counter(item) ". ";
            color: #ffd700;
            font-weight: bold;
            margin-right: 5px;
        }
    
        .high-scores {
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #ff00ff;
            padding: 10px;
            margin: 10px 0;
        }
    
        .high-scores h3 {
            color: #ff00ff;
            font-size: 12px;
            margin-bottom: 10px;
        }
    
        .high-score-entry {
            display: flex;
            justify-content: space-between;
            padding: 5px;
            margin: 3px 0;
            border-bottom: 1px solid #444;
            font-size: 8px;
        }
    
        .arcade-button {
            background: linear-gradient(180deg, #ff0000 0%, #cc0000 100%);
            color: #fff;
            border: 3px solid #fff;
            padding: 10px 20px;
            font-family: 'Press Start 2P', cursive;
            font-size: 10px;
            cursor: pointer;
            margin: 5px;
            box-shadow: 0 4px 0 #800000, 0 6px 15px rgba(0, 0, 0, 0.5);
            transition: transform 0.1s;
        }
    
        .arcade-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 0 #800000, 0 8px 20px rgba(255, 0, 0, 0.5);
        }
    
        .arcade-button:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #800000;
        }
    
        .arcade-button.secondary {
            background: linear-gradient(180deg, #4a90e2 0%, #2563eb 100%);
            box-shadow: 0 4px 0 #1e40af, 0 6px 15px rgba(0, 0, 0, 0.5);
        }
    
        .arcade-button.secondary:hover {
            box-shadow: 0 5px 0 #1e40af, 0 8px 20px rgba(37, 99, 235, 0.5);
        }
    
        .arcade-button.secondary:active {
            box-shadow: 0 2px 0 #1e40af;
        }
    
        .progress-text {
            text-align: center;
            font-size: 10px;
            color: #ffff00;
            margin-top: 5px;
        }
    
        .name-input-screen {
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            border: 4px solid #ffd700;
            padding: 20px;
            text-align: center;
            min-height: 400px;
            margin-top: 20px;
        }
    
        .name-input-screen h2 {
            font-size: 14px;
            color: #ffd700;
            margin-bottom: 15px;
        }
    
        .name-input-screen input {
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #00ff00;
            color: #00ff00;
            font-family: 'Press Start 2P', cursive;
            font-size: 12px;
            padding: 10px;
            width: 100%;
           
            max-width: 250px;
            text-align: center;
            margin-bottom: 15px;
        }
    
        .screenshot-area {
            background: linear-gradient(180deg, #1a4d8f 0%, #0d2847 100%);
            border: 4px solid #ffd700;
            padding: 20px;
            margin: 10px auto;
            max-width: 400px;
        }
    
        .audio-toggle {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #ffd700;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1001;
            font-size: 24px;
            transition: transform 0.2s;
        }
    
        .audio-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.8);
        }
    
        .audio-toggle:active {
            transform: scale(0.95);
        }
    
        @keyframes screen-shake {
            0%, 100% { transform: translate(0, 0); }
            10% { transform: translate(-5px, 2px); }
            20% { transform: translate(5px, -2px); }
            30% { transform: translate(-5px, -2px); }
            40% { transform: translate(5px, 2px); }
            50% { transform: translate(-5px, 2px); }
            60% { transform: translate(5px, -2px); }
            70% { transform: translate(-5px, -2px); }
            80% { transform: translate(5px, 2px); }
            90% { transform: translate(-5px, -2px); }
        }
    
        .shake {
            animation: screen-shake 0.5s;
        }
    
        @keyframes invert-flash {
            0%, 100% { filter: invert(0); }
            50% { filter: invert(1); }
        }
    
        .invert {
            animation: invert-flash 0.4s;
        }
    
        @keyframes wave-distort {
            0% { transform: skewX(0deg); }
            25% { transform: skewX(5deg); }
            50% { transform: skewX(-5deg); }
            75% { transform: skewX(5deg); }
            100% { transform: skewX(0deg); }
        }
    
        .wave {
            animation: wave-distort 0.6s;
        }
    
        .anime-cutscene {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2000;
            pointer-events: none;
            display: none;
        }
    
        .anime-cutscene.active {
            display: block;
        }
    
        .anime-iris {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 0;
            height: 80px;
            background: linear-gradient(90deg, #ff0000, #ff00ff, #00ffff, #ffff00);
            animation: iris-expand 1s forwards;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: #fff;
            text-shadow: 2px 2px 0 #000;
        }
    
        @keyframes iris-expand {
            0% { width: 0; }
            50% { width: 100%; }
            100% { width: 100%; opacity: 0; }
        }
    
        .anime-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, transparent 20%, rgba(0, 0, 0, 0.9) 80%);
            animation: dark-fade 1s;
        }
    
        @keyframes dark-fade {
            0% { opacity: 0; }
            20% { opacity: 1; }
            80% { opacity: 1; }
            100% { opacity: 0; }
        }
    
        .sprite-effect {
            position: fixed;
            width: 60px;
            height: 60px;
            pointer-events: none;
            z-index: 1500;
            animation: sprite-float 1s forwards;
        }
    
        @keyframes sprite-float {
            0% { transform: scale(0) rotate(0deg); opacity: 1; }
            50% { transform: scale(1.2) rotate(180deg); opacity: 1; }
            100% { transform: scale(1.5) rotate(360deg); opacity: 0; }
        }
    
        .background-image {
            position: fixed;
            bottom: 20;
            left: 20;
            width: 100%;
            height: 30vh;
            z-index: -1;
            pointer-events: none;
        }
    
        .background-image img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            object-position: center bottom;
            display: block;
        }

        .ko-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2500;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
    
        .ko-overlay.active {
            display: flex;
            animation: ko-fade-in 0.5s;
        }
    
        @keyframes ko-fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    
        .ko-text {
            font-size: 72px;
            color: #ff0000;
            text-shadow: 
                3px 3px 0 #fff,
                6px 6px 0 #000,
                0 0 30px #ff0000;
            animation: ko-zoom 1s ease-out;
            margin-bottom: 20px;
        }
    
        @keyframes ko-zoom {
            0% { transform: scale(0) rotate(-10deg); opacity: 0; }
            50% { transform: scale(1.2) rotate(5deg); }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
    
        .ko-subtext {
            font-size: 20px;
            color: #ffd700;
            text-shadow: 2px 2px 0 #000;
            animation: ko-fade-in 1s 0.5s both;
        }
    
        @media (max-width: 600px) {
            .game-container { padding: 5px; }
            .header { padding: 8px; }
            .title { font-size: 16px; }
            .timer-display { font-size: 20px; }
            .score-display { font-size: 16px; }
            .arena { padding: 8px; min-height: 200px; }
            .choices { gap: 5px; }
            .choice-card { font-size: 11px; min-height: 70px; padding: 5px; }
            .multiplier { font-size: 9px; padding: 4px 8px; }
            .ko-text { font-size: 48px; }
            .ko-subtext { font-size: 16px; }
        }
    
        </style>
</head>
<body>
    <div class="crt-overlay"></div>
    
    <!-- Background music audio element -->
    <audio id="bgMusic" loop>
        <source src="abg.mp3" type="audio/mpeg">
    </audio>
    
    <div class="audio-toggle" id="audioToggle" onclick="toggleAudio()">üîá</div>
    
    <div class="ko-overlay" id="koOverlay">
        <div class="ko-text">K.O.!</div>
        <div class="ko-subtext">YOU WIN.</div>
    </div>
    
    <div class="anime-cutscene" id="animeCutscene">
        <div class="anime-background"></div>
        <div class="anime-iris" id="animeIris">üí• CRITICAL! üí•</div>
    </div>
    
    <div class="game-container" id="gameContainer">
        
        <div class="name-input-screen" id="nameInputScreen">
            <h2>ENTER YOUR NAME</h2>
            <input type="text" id="playerName" maxlength="10" placeholder="PLAYER1" />
            <div>
                <button class="arcade-button" onclick="startGame()">START GAME</button>
            </div>
            <div style="margin-top: 130px;">
                <button class="arcade-button secondary" onclick="submitActivityIdea()" >SUGGEST IDEA</button>
            </div>
        </div>

        <div class="name-input-screen" id="activitySubmitScreen" style="display: none;">
        </div>

        <div id="gameScreen" style="display: none;">
            <div class="header">
                <div class="title">FHE FIGHTER II</div>
                <div class="timer-display" id="timer">15.00</div>
                <div class="score-display" id="score">SCORE: 0</div>
                <div class="multipliers" id="multipliers"></div>
                <div class="health-bars">
                    <div class="health-bar-container">
                        <div class="health-label">ENEMY HP</div>
                        <div class="health-bar-outer">
                            <div class="health-bar-inner" id="progressBar" style="width: 100%;">
                                <div class="health-bar-segments">
                                    <div class="health-segment"></div>
                                    <div class="health-segment"></div>
                                    <div class="health-segment"></div>
                                    <div class="health-segment"></div>
                                    <div class="health-segment"></div>
                                    <div class="health-segment"></div>
                                    <div class="health-segment"></div>
                                    <div class="health-segment"></div>
                                    <div class="health-segment"></div>
                                    <div class="health-segment"></div>
                                </div>
                            </div>
                           
                        </div>
                    </div>
                </div>
            </div>

            <div class="arena">
                <div class="instruction">TAP TO CHOOSE YOUR FAVORITE!</div>
                <div class="choices" id="choices"></div>
                <div class="progress-text" id="progressMessage"></div>
            </div>
        </div>

        <div class="results-screen" id="resultsScreen">
            <div class="screenshot-area" id="screenshotArea">
                <div class="title">GAME OVER</div>
                <div class="final-score" id="finalScore">0</div>
                <div style="font-size: 14px; color: #ffd700; margin: 10px 0;" id="playerNameDisplay"></div>
                
                <div class="top-picks">
                    <h3>YOUR TOP 5 ACTIVITIES</h3>
                    <ol id="topPicksList"></ol>
                </div>
            </div>

            <div class="high-scores">
                <h3>HIGH SCORES</h3>
                <div id="highScoresList"></div>
            </div>

            <div>
                <button class="arcade-button secondary" onclick="shareScore()">SHARE SCORE</button>
                <button class="arcade-button" onclick="resetGame()">PLAY AGAIN</button>
            </div>
        </div>
    </div>
 <!-- Background Image at Bottom -->
 <div class="background-image">
    <img src="bg2.png" alt="Background">
</div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
    const GOOGLE_SHEET_URL = 'https://script.google.com/macros/s/AKfycbwjPdmkcpuRZJeQjdF53ZvPsILjnnecRAIfdbV1qqJ3knO-Kgx5IJNz557hrxIs80G3/exec';
    
    let audioEnabled = false;
    let bgMusic = null;
    
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    let audioCtx = null;
    
    function initAudio() {
        if (!audioCtx) {
            audioCtx = new AudioContext();
        }
        if (!bgMusic) {
            bgMusic = document.getElementById('bgMusic');
        }
    }
    
    function toggleAudio() {
        audioEnabled = !audioEnabled;
        const toggle = document.getElementById('audioToggle');
        toggle.textContent = audioEnabled ? 'üéµ' : 'üîá';
        
        if (audioEnabled) {
            initAudio();
            if (bgMusic) {
                bgMusic.volume = 0.3; // Set volume to 30%
                bgMusic.play().catch(err => console.log('Audio play failed:', err));
            }
        } else {
            if (bgMusic) {
                bgMusic.pause();
            }
        }
    }
     
    // Stop audio when page is hidden (tab switched or browser closed)
    document.addEventListener('visibilitychange', function() {
        if (document.hidden && bgMusic && !bgMusic.paused) {
            bgMusic.pause();
        } else if (!document.hidden && audioEnabled && bgMusic && bgMusic.paused) {
            bgMusic.play().catch(err => console.log('Audio play failed:', err));
        }
    });
    
    // Stop audio when page is about to unload
    window.addEventListener('beforeunload', function() {
        if (bgMusic) {
            bgMusic.pause();
            bgMusic.currentTime = 0;
        }
    });
    
    // Stop audio when page loses focus (iOS Safari specific)
    window.addEventListener('pagehide', function() {
        if (bgMusic) {
            bgMusic.pause();
            bgMusic.currentTime = 0;
        }
    });
    
    // Stop audio when browser goes to background (iOS specific)
    window.addEventListener('blur', function() {
        if (bgMusic && !bgMusic.paused) {
            bgMusic.pause();
        }
    });
    
    function playSound(type) {
        if (!audioEnabled || !audioCtx) return;
        
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        
        switch(type) {
            case 'select':
                oscillator.frequency.value = 800;
                oscillator.type = 'square';
                gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                oscillator.start(audioCtx.currentTime);
                oscillator.stop(audioCtx.currentTime + 0.1);
                break;
            case 'combo':
                oscillator.frequency.value = 1200;
                oscillator.type = 'sine';
                gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                oscillator.start(audioCtx.currentTime);
                oscillator.stop(audioCtx.currentTime + 0.3);
                break;
            case 'critical':
                for (let i = 0; i < 3; i++) {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    osc.frequency.value = 1500 + (i * 200);
                    osc.type = 'sawtooth';
                    gain.gain.setValueAtTime(0.2, audioCtx.currentTime + i * 0.1);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.4 + i * 0.1);
                    osc.start(audioCtx.currentTime + i * 0.1);
                    osc.stop(audioCtx.currentTime + 0.4 + i * 0.1);
                }
                break;
            case 'bonus':
                oscillator.frequency.value = 600;
                oscillator.type = 'triangle';
                gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
                oscillator.start(audioCtx.currentTime);
                oscillator.stop(audioCtx.currentTime + 0.2);
                break;
            case 'name':
                oscillator.frequency.value = 400;
                oscillator.type = 'square';
                gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
                oscillator.start(audioCtx.currentTime);
                oscillator.stop(audioCtx.currentTime + 0.15);
                break;
        }
    }
    
    const ACTIVITIES = [
        "Board Games", "Nature Walk", "Nerf Guns", "Family Feud", "Charades", 
        "Nursing Home", "Small Group Dinners", "Local Band", "Frisbee Golf", 
        "Capture The Flag", "Thrift Swap", "Cookie Decorating", "Four Square", 
        "Volleyball", "Poetry Slam", "Pancakes", "AI Workshop", "Career Panel", 
        "Meal Delivery", "Dodgeball", "Mental Health", "Karaoke Night", 
        "City Council Meeting", "Burn Stuff", "Sardines", "PowerPoint Night",
        "Pickleball", "Arts & Crafts", "Chair Soccer", "Video Games"
    ];

    const FAKE_HIGH_SCORES = [
        { name: "RYU", score: 8750 },
        { name: "D&C", score: 8200 },
        { name: "JST", score: 7890 },
        { name: "ROUGE", score: 7450 },
        { name: "YSA", score: 7100 },
        { name: "DALLIN", score: 6800 },
        { name: "AMY", score: 6550 },
        { name: "1820", score: 6200 }
    ];

    let gameState = {
        playerName: '',
        score: 0,
        current: [],
        evaluating: [],
        survived: [],
        eliminated: {},
        favorites: [],
        timer: 15,
        timerInterval: null,
        highScores: [...FAKE_HIGH_SCORES]
    };

    const BATCH_SIZE = 3;

    function shuffle(array) {
        const arr = [...array];
        for (let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
    }

    function getAvailableItems() {
        return ACTIVITIES.filter(id => 
            !gameState.favorites.includes(id) && 
            !gameState.eliminated[id]
        );
    }

    function startGame() {
        const nameInput = document.getElementById('playerName').value.trim() || 'PLAYER1';
        gameState.playerName = nameInput.toUpperCase().slice(0, 10);
        
        playSound('name');
        
        document.getElementById('nameInputScreen').style.display = 'none';
        document.getElementById('gameScreen').style.display = 'block';
        
        startNewRound();
    }

    function startNewRound() {
        const available = getAvailableItems();
        
        if (available.length === 0) {
            endGame();
            return;
        }
        
        if (available.length === 1) {
            addFavorite(available[0]);
            return;
        }
        
        gameState.current = shuffle(available);
        gameState.evaluating = [];
        gameState.survived = [];
        
        loadNextBatch();
    }

    function loadNextBatch() {
        if (gameState.current.length === 0) {
            finalizeRound();
            return;
        }
        
        const batchSize = Math.min(BATCH_SIZE, gameState.current.length);
        gameState.evaluating = gameState.current.splice(0, batchSize);
        gameState.timer = 15;
        
        renderBatch();
        startTimer();
        updateUI();
    }

    function finalizeRound() {
        if (gameState.survived.length === 1) {
            addFavorite(gameState.survived[0]);
            return;
        }
        
        if (gameState.survived.length === 0) {
            endGame();
            return;
        }
        
        gameState.current = shuffle(gameState.survived);
        gameState.survived = [];
        loadNextBatch();
    }

    function addFavorite(itemId) {
        if (gameState.favorites.includes(itemId)) return;
        
        gameState.favorites.push(itemId);
        delete gameState.eliminated[itemId];
        
        rescueEligibleItems();
        
        if (gameState.favorites.length >= 5) {
            endGame();
            return;
        }
        
        startNewRound();
    }

    function rescueEligibleItems() {
        const toRescue = [];
        
        Object.keys(gameState.eliminated).forEach(id => {
            const eliminatedBy = gameState.eliminated[id].eliminatedBy || [];
            if (eliminatedBy.length === 0) return;
            
            const allAreFavorites = eliminatedBy.every(e => gameState.favorites.includes(e));
            if (allAreFavorites) {
                toRescue.push(id);
            }
        });
        
        toRescue.forEach(id => delete gameState.eliminated[id]);
    }

    function renderBatch() {
        const choicesEl = document.getElementById('choices');
        choicesEl.innerHTML = '';
        
        gameState.evaluating.forEach(activity => {
            const card = document.createElement('div');
            card.className = 'choice-card';
            card.textContent = activity;
            card.dataset.activityId = activity;
            card.onclick = () => selectActivity(activity, card);
            choicesEl.appendChild(card);
        });
    }

    function selectActivity(activity, element) {
        stopTimer();
        
        playSound('select');
        
        const timeBonus = Math.floor(gameState.timer * 10);
        let points = 200 + timeBonus;
        const multipliers = [];
        let effectType = 'normal';

        if (gameState.timer < 9) {
            points += 100;
            multipliers.push('COMBO!');
            playSound('combo');
            effectType = 'shake';
        }

        const timeStr = gameState.timer.toFixed(2);
        const lastDigit = timeStr[timeStr.length - 1];
        if (lastDigit === '0' || lastDigit === '5') {
            points += 500;
            multipliers.push('CRITICAL!');
            playSound('critical');
            effectType = 'anime';
        }

        if (timeStr.includes('6') && timeStr.includes('7')) {
            points += 777;
            multipliers.push('6-7 BONUS!');
            playSound('bonus');
            effectType = 'wave';
        }

        if (Math.random() > 0.7) {
            points += Math.floor(Math.random() * 300);
            multipliers.push('LUCKY!');
            playSound('bonus');
            if (effectType === 'normal') effectType = 'invert';
        }

        gameState.score += points;
        
        applyScreenEffect(effectType);
        
        gameState.survived.push(activity);
        
        const losers = gameState.evaluating.filter(a => a !== activity);
        losers.forEach(loser => {
            if (!gameState.eliminated[loser]) {
                gameState.eliminated[loser] = { eliminatedBy: [] };
            }
            if (!gameState.eliminated[loser].eliminatedBy.includes(activity)) {
                gameState.eliminated[loser].eliminatedBy.push(activity);
            }
        });

        gameState.evaluating = [];

        showMultipliers(multipliers);
        createExplosion(element);
        showFloatingScore(element, points);
        createSpriteEffect(element);
        
        document.querySelectorAll('.choice-card').forEach(card => {
            card.style.opacity = '0';
            card.style.pointerEvents = 'none';
        });

        setTimeout(() => {
            loadNextBatch();
        }, 1500);
    }

    function showFloatingScore(element, points) {
        const rect = element.getBoundingClientRect();
        const scoreEl = document.createElement('div');
        scoreEl.className = 'floating-score';
        scoreEl.textContent = `+${points}`;
        
        scoreEl.style.left = (rect.right - 10) + 'px'; 
        scoreEl.style.top = (rect.top + 10) + 'px';
        
        document.body.appendChild(scoreEl);
        
        setTimeout(() => scoreEl.remove(), 1000);
    }

    function applyScreenEffect(type) {
        const container = document.getElementById('gameContainer');
        
        switch(type) {
            case 'shake':
                container.classList.add('shake');
                setTimeout(() => container.classList.remove('shake'), 500);
                break;
            case 'invert':
                container.classList.add('invert');
                setTimeout(() => container.classList.remove('invert'), 400);
                break;
            case 'wave':
                container.classList.add('wave');
                setTimeout(() => container.classList.remove('wave'), 600);
                break;
            case 'anime':
                showAnimeCutscene();
                break;
        }
    }

    function showAnimeCutscene() {
        const cutscene = document.getElementById('animeCutscene');
        const iris = document.getElementById('animeIris');
        
        const messages = ['üí• CRITICAL! üí•', '‚ö° ULTRA COMBO! ‚ö°', 'üåü LEGENDARY! üåü'];
        iris.textContent = messages[Math.floor(Math.random() * messages.length)];
        
        cutscene.classList.add('active');
        setTimeout(() => cutscene.classList.remove('active'), 1000);
    }

    function createSpriteEffect(element) {
        const sprites = ['‚≠ê', 'üí´', '‚ú®', 'üåü', 'üí•', '‚ö°', 'üî•'];
        const rect = element.getBoundingClientRect();
        
        for (let i = 0; i < 3; i++) {
            setTimeout(() => {
                const sprite = document.createElement('div');
                sprite.className = 'sprite-effect';
                sprite.textContent = sprites[Math.floor(Math.random() * sprites.length)];
                sprite.style.left = (rect.left + Math.random() * rect.width) + 'px';
                sprite.style.top = (rect.top + Math.random() * rect.height) + 'px';
                document.body.appendChild(sprite);
                
                setTimeout(() => sprite.remove(), 1000);
            }, i * 150);
        }
    }

    function createExplosion(element) {
        const explosions = ['üí•', '‚ö°', 'üåü', 'üí´', '‚ú®'];
        const rect = element.getBoundingClientRect();
        
        for (let i = 0; i < 5; i++) {
            const explosion = document.createElement('div');
            explosion.className = 'explosion';
            explosion.textContent = explosions[Math.floor(Math.random() * explosions.length)];
            explosion.style.position = 'fixed'; 
            explosion.style.left = (rect.left + Math.random() * rect.width) + 'px';
            explosion.style.top = (rect.top + Math.random() * rect.height) + 'px';
            document.body.appendChild(explosion);
            
            setTimeout(() => explosion.remove(), 600);
        }
    }

    function showMultipliers(multipliers) {
        const multipliersEl = document.getElementById('multipliers');
        multipliersEl.innerHTML = '';
        
        multipliers.forEach((text, i) => {
            setTimeout(() => {
                const mult = document.createElement('div');
                mult.className = 'multiplier';
                mult.textContent = text;
                multipliersEl.appendChild(mult);
                
                setTimeout(() => mult.remove(), 2000);
            }, i * 200);
        });
    }

    function startTimer() {
        const timerEl = document.getElementById('timer');
        gameState.timerInterval = setInterval(() => {
            gameState.timer -= 0.01;
            
            if (gameState.timer <= 0) {
                gameState.timer = 0;
                stopTimer();
                const randomActivity = gameState.evaluating[Math.floor(Math.random() * gameState.evaluating.length)];
                
                const choices = document.getElementById('choices');
                const randomCard = Array.from(choices.children).find(card => card.dataset.activityId === randomActivity);
                
                if (randomCard) {
                    selectActivity(randomActivity, randomCard);
                } else {
                    console.error("Could not find card for random selection.");
                    loadNextBatch();
                }
            }
            
            timerEl.textContent = gameState.timer.toFixed(2);
            timerEl.className = 'timer-display';
            if (gameState.timer < 5) timerEl.className += ' danger';
            else if (gameState.timer < 10) timerEl.className += ' warning';
        }, 10);
    }

    function stopTimer() {
        if (gameState.timerInterval) {
            clearInterval(gameState.timerInterval);
            gameState.timerInterval = null;
        }
    }

    function updateUI() {
        const available = getAvailableItems();
        const remaining = available.length;
        const totalActivities = ACTIVITIES.length;
        const favoritesCollected = gameState.favorites.length;
        const maxFavorites = 5;
        
        document.getElementById('score').textContent = `SCORE: ${gameState.score}`;
        
        // Calculate progress: starts at 100% (30 remaining, 0 favorites)
        // Decreases as we eliminate activities and collect favorites
        // Goal: get to 0 HP (5 favorites collected, all others eliminated)
        const totalProgress = maxFavorites + (totalActivities - maxFavorites);
        const currentProgress = remaining + (maxFavorites - favoritesCollected);
        const progressPercent = (currentProgress / totalProgress) * 100;
        
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        
        progressBar.style.width = progressPercent + '%';
       
        
        // Change color based on progress (enemy losing HP)
        progressBar.className = 'health-bar-inner';
        if (progressPercent < 20) {
            progressBar.classList.add('critical');
        } else if (progressPercent < 40) {
            progressBar.classList.add('low');
        }
        
        // Update progress message to clarify elimination vs favorites
        const progressMsg = document.getElementById('progressMessage');
        const picksLeft = maxFavorites - favoritesCollected;
        
        if (favoritesCollected === 0) {
            progressMsg.textContent = `${remaining} ACTIVITIES IN THE FIGHT!`;
        } else if (picksLeft > 3) {
            progressMsg.textContent = `${favoritesCollected} FAVORITE${favoritesCollected > 1 ? 'S' : ''} LOCKED! ${picksLeft} SPOTS LEFT!`;
        } else if (picksLeft > 1) {
            progressMsg.textContent = `${favoritesCollected} DOWN, ${picksLeft} TO GO! ALMOST DONE!`;
        } else if (picksLeft === 1) {
            progressMsg.textContent = `BOSS FIGHT! ONE MORE FAVORITE TO COMPLETE YOUR TOP 5!`;
        }
    }

    function endGame() {
        stopTimer();
        
        // Show K.O. overlay
        const koOverlay = document.getElementById('koOverlay');
        koOverlay.classList.add('active');
        
        // Play final sound effect
        if (audioEnabled) {
            playSound('critical');
            setTimeout(() => playSound('combo'), 300);
        }
        
        // After K.O. animation, show results
        setTimeout(() => {
            koOverlay.classList.remove('active');
            document.getElementById('gameScreen').style.display = 'none';
            document.getElementById('resultsScreen').classList.add('active');
            
            document.getElementById('finalScore').textContent = gameState.score;
            document.getElementById('playerNameDisplay').textContent = gameState.playerName;
            
            const topPicksList = document.getElementById('topPicksList');
            topPicksList.innerHTML = '';
            gameState.favorites.forEach(pick => {
                const li = document.createElement('li');
                li.textContent = pick;
                topPicksList.appendChild(li);
            });
            
            gameState.highScores.push({ 
                name: gameState.playerName, 
                score: gameState.score 
            });
            gameState.highScores.sort((a, b) => b.score - a.score);
            gameState.highScores = gameState.highScores.slice(0, 8);
            
            const highScoresList = document.getElementById('highScoresList');
            highScoresList.innerHTML = '';
            gameState.highScores.forEach((entry, i) => {
                const div = document.createElement('div');
                div.className = 'high-score-entry';
                div.innerHTML = `<span>${i + 1}. ${entry.name}</span><span>${entry.score}</span>`;
                highScoresList.appendChild(div);
            });
            
            submitToGoogleForm();
        }, 2500);
    }

    function submitToGoogleForm() {
        const params = new URLSearchParams();
        params.append('name', gameState.playerName);
        params.append('score', gameState.score);
        params.append('picks', gameState.favorites.join(', '));
        
        fetch(GOOGLE_SHEET_URL + '?' + params.toString(), {
            method: 'GET',
            mode: 'no-cors'
        }).catch(err => console.log('Form submission:', err));
    }

    async function shareScore() {
        const screenshotArea = document.getElementById('screenshotArea');
        
        try {
            const canvas = await html2canvas(screenshotArea, {
                backgroundColor: '#0d2847',
                scale: 2
            });
            
            canvas.toBlob(async (blob) => {
                const file = new File([blob], 'fhe-score.png', { type: 'image/png' });
                
                if (navigator.share && navigator.canShare({ files: [file] })) {
                    await navigator.share({
                        files: [file],
                        title: 'My FHE Fighter Score!',
                        text: `I scored ${gameState.score} points in FHE Fighter II!`
                    });
                } else {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'fhe-fighter-score.png';
                    a.click();
                    URL.revokeObjectURL(url);
                    alert('Screenshot saved! Share it with your friends!');
                }
            });
        } catch (err) {
            console.error('Screenshot failed:', err);
            alert('Could not create screenshot. Try taking a screenshot manually!');
        }
    }

    function resetGame() {
        gameState = {
            playerName: '',
            score: 0,
            current: [],
            evaluating: [],
            survived: [],
            eliminated: {},
            favorites: [],
            timer: 15,
            timerInterval: null,
            highScores: gameState.highScores
        };
        
        document.getElementById('resultsScreen').classList.remove('active');
        document.getElementById('nameInputScreen').style.display = 'block';
        document.getElementById('playerName').value = '';
        document.getElementById('multipliers').innerHTML = '';
        document.getElementById('gameScreen').style.display = 'none';
    }
    function submitActivityIdea() {
        playSound('name');
      window.location.href = 'mailto:email@daviddot.com?subject=FHE Activity Idea';
    }
    </script>
</body>
</html>
